<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html lang='en'>
  <head>
    <title>: Spider::Model::Mapper [Spider documentation]</title>
    <meta content='text/html; charset=UTF-8' http-equiv='Content-Type'>
    <link href='../../../rdoc-style.css' media='screen' rel='stylesheet' type='text/css'>
    <script type='text/javascript'>
      //<![CDATA[
        function popupCode(url) {
          window.open(url, "Code", "resizable=yes,scrollbars=yes,toolbar=no,status=no,height=150,width=400")
        }
        
        function toggleCode(id) {
          var code = document.getElementById(id)
        
          code.style.display = code.style.display != 'block' ? 'block' : 'none'
          return true
        }
        
        // Make codeblocks hidden by default
        document.writeln('<' + 'style type="text/css">.method .source pre { display: none }<\/style>')
      //]]>
    </script>
  </head>
  <body class='page'>
    <div class='class' id='wrapper'>
      <div class='header'>
        <h1 class='name'>
          <span class='type'>Class</span>
          Spider::Model::Mapper
        </h1>
        <ol class='paths'>
          <li>
            <a href="../../../files/lib/spiderfw/model/mappers/mapper_rb.html">lib/spiderfw/model/mappers/mapper.rb</a>
            (<a href="http://github.com/me/spider/tree/master/lib/spiderfw/model/mappers/mapper.rb">view online</a>)
          </li>
        </ol>
        <div class='parent'>
          Parent:
          <strong>Object</strong>
        </div>
      </div>
      <div id='content'>
        <div id='text'>
          <div id='description'>
            <p>
            The <a href="Mapper.html">Mapper</a> connects a <a
            href="BaseModel.html">BaseModel</a> to a <a
            href="Storage.html">Storage</a>; it fetches data from the <a
            href="Storage.html">Storage</a> and converts it to objects, and vice versa.
            It is not usually called directly; the <a
            href="BaseModel.html">BaseModel</a> provides methods for interacting with
            the mapper. Its methods may be overridden with <a
            href="BaseModel.html#M000543">BaseModel#with_mapper</a>, though.
            </p>
          </div>
          <div id='method-list'>
            <h2>Methods</h2>
            <h3>public class</h3>
            <ol>
              <li><a href="#M000414">new</a></li>
              <li><a href="#M000413">write?</a></li>
            </ol>
            <h3>public instance</h3>
            <ol>
              <li><a href="#M000422">after_save</a></li>
              <li><a href="#M000424">association_elements</a></li>
              <li><a href="#M000420">before_insert</a></li>
              <li><a href="#M000419">before_save</a></li>
              <li><a href="#M000421">before_update</a></li>
              <li><a href="#M000443">count</a></li>
              <li><a href="#M000431">delete</a></li>
              <li><a href="#M000433">delete_all!</a></li>
              <li><a href="#M000426">delete_element_associations</a></li>
              <li><a href="#M000434">do_delete</a></li>
              <li><a href="#M000435">do_insert</a></li>
              <li><a href="#M000436">do_update</a></li>
              <li><a href="#M000452">expand_request</a></li>
              <li><a href="#M000444">fetch</a></li>
              <li><a href="#M000442">find</a></li>
              <li><a href="#M000454">get_dependencies</a></li>
              <li><a href="#M000446">get_external</a></li>
              <li><a href="#M000447">get_external_element</a></li>
              <li><a href="#M000418">have_references?</a></li>
              <li><a href="#M000429">insert</a></li>
              <li><a href="#M000441">load</a></li>
              <li><a href="#M000439">load_element</a></li>
              <li><a href="#M000440">load_element!</a></li>
              <li><a href="#M000437">lock</a></li>
              <li><a href="#M000445">map</a></li>
              <li><a href="#M000449">map_back_value</a></li>
              <li><a href="#M000416">mapped?</a></li>
              <li><a href="#M000415">no_map</a></li>
              <li><a href="#M000417">normalize</a></li>
              <li><a href="#M000432">prepare_delete_condition</a></li>
              <li><a href="#M000450">prepare_query</a></li>
              <li><a href="#M000453">prepare_query_condition</a></li>
              <li><a href="#M000451">prepare_query_request</a></li>
              <li><a href="#M000448">queryset_siblings</a></li>
              <li><a href="#M000423">save</a></li>
              <li><a href="#M000428">save_all</a></li>
              <li><a href="#M000425">save_associations</a></li>
              <li><a href="#M000427">save_element_associations</a></li>
              <li><a href="#M000438">sequence_next</a></li>
              <li><a href="#M000430">update</a></li>
            </ol>
          </div>
          <div id='section'>
            <div id='attribute-list'>
              <h2 class='section-bar'>Attributes</h2>
              <div class='name-list'>
                <table>
                  <tr class='top-aligned-row context-row'>
                    <td class='context-item-name'>storage</td>
                    <td class='context-item-value'>[RW]</td>
                    <td class='context-item-desc'></td>
                  </tr>
                  <tr class='top-aligned-row context-row'>
                    <td class='context-item-name'>type</td>
                    <td class='context-item-value'>[R]</td>
                    <td class='context-item-desc'></td>
                  </tr>
                </table>
              </div>
            </div>
            <div id='methods'>
              <h2>Public class methods</h2>
              <div class='public-class method' id='method-M000414'>
                <a name='M000414'>      </a>
                <div class='synopsis'>
                  <span class='name'>new</span>
                  <span class='arguments'>(model, storage)</span>
                </div>
                <div class='description'>
                  <p>
                  Takes a <a href="BaseModel.html">BaseModel</a> class and a storage
                  instance.
                  </p>
                </div>
                <div class='source'>
                  <a class='source-toggle' href='#' onclick="toggleCode('M000414-source'); return false">
                    [show source]
                  </a>
                  <pre id='M000414-source'><span class="ruby-comment cmt"># File lib/spiderfw/model/mappers/mapper.rb, line 18</span>&#x000A;        <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">initialize</span>(<span class="ruby-identifier">model</span>, <span class="ruby-identifier">storage</span>)&#x000A;            <span class="ruby-ivar">@model</span> = <span class="ruby-identifier">model</span>&#x000A;            <span class="ruby-ivar">@storage</span> = <span class="ruby-identifier">storage</span>&#x000A;            <span class="ruby-ivar">@raw_data</span> = {}&#x000A;            <span class="ruby-ivar">@options</span> = {}&#x000A;            <span class="ruby-ivar">@no_map_elements</span> = {}&#x000A;            <span class="ruby-ivar">@sequences</span> = []&#x000A;        <span class="ruby-keyword kw">end</span></pre>
                </div>
              </div>
              <div class='public-class method' id='method-M000413'>
                <a name='M000413'>      </a>
                <div class='synopsis'>
                  <span class='name'>write?</span>
                  <span class='arguments'>()</span>
                </div>
                <div class='description'>
                  <p>
                  Returns whether this <a href="Mapper.html">Mapper</a> can write to the
                  storage.
                  </p>
                </div>
                <div class='source'>
                  <a class='source-toggle' href='#' onclick="toggleCode('M000413-source'); return false">
                    [show source]
                  </a>
                  <pre id='M000413-source'><span class="ruby-comment cmt"># File lib/spiderfw/model/mappers/mapper.rb, line 13</span>&#x000A;        <span class="ruby-keyword kw">def</span> <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">write?</span>&#x000A;            <span class="ruby-keyword kw">true</span>&#x000A;        <span class="ruby-keyword kw">end</span></pre>
                </div>
              </div>
              <h2>Public instance methods</h2>
              <div class='public-instance method' id='method-M000422'>
                <a name='M000422'>      </a>
                <div class='synopsis'>
                  <span class='name'>after_save</span>
                  <span class='arguments'>(obj, mode)</span>
                </div>
                <div class='description'>
                  <p>
                  Called after a succesful save. &#8216;mode&#8217; can be :insert or
                  :update.
                  </p>
                </div>
                <div class='source'>
                  <a class='source-toggle' href='#' onclick="toggleCode('M000422-source'); return false">
                    [show source]
                  </a>
                  <pre id='M000422-source'><span class="ruby-comment cmt"># File lib/spiderfw/model/mappers/mapper.rb, line 150</span>&#x000A;        <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">after_save</span>(<span class="ruby-identifier">obj</span>, <span class="ruby-identifier">mode</span>)&#x000A;            <span class="ruby-identifier">save_associations</span>(<span class="ruby-identifier">obj</span>)&#x000A;            <span class="ruby-identifier">obj</span>.<span class="ruby-identifier">reset_modified_elements</span>&#x000A;        <span class="ruby-keyword kw">end</span></pre>
                </div>
              </div>
              <div class='public-instance method' id='method-M000424'>
                <a name='M000424'>      </a>
                <div class='synopsis'>
                  <span class='name'>association_elements</span>
                  <span class='arguments'>()</span>
                </div>
                <div class='description'>
                  <p>
                  Elements that are associated to this one externally.
                  </p>
                </div>
                <div class='source'>
                  <a class='source-toggle' href='#' onclick="toggleCode('M000424-source'); return false">
                    [show source]
                  </a>
                  <pre id='M000424-source'><span class="ruby-comment cmt"># File lib/spiderfw/model/mappers/mapper.rb, line 186</span>&#x000A;        <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">association_elements</span>&#x000A;             <span class="ruby-ivar">@model</span>.<span class="ruby-identifier">elements_array</span>.<span class="ruby-identifier">select</span>{ <span class="ruby-operator">|</span><span class="ruby-identifier">el</span><span class="ruby-operator">|</span> <span class="ruby-identifier">mapped?</span>(<span class="ruby-identifier">el</span>) <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-operator">!</span><span class="ruby-identifier">el</span>.<span class="ruby-identifier">integrated?</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-operator">!</span><span class="ruby-identifier">have_references?</span>(<span class="ruby-identifier">el</span>) }&#x000A;        <span class="ruby-keyword kw">end</span></pre>
                </div>
              </div>
              <div class='public-instance method' id='method-M000420'>
                <a name='M000420'>      </a>
                <div class='synopsis'>
                  <span class='name'>before_insert</span>
                  <span class='arguments'>(obj)</span>
                </div>
                <div class='description'>
                  <p>
                  Hook to provide custom preprocessing. The default implementation does
                  nothing.
                  </p>
                </div>
                <div class='source'>
                  <a class='source-toggle' href='#' onclick="toggleCode('M000420-source'); return false">
                    [show source]
                  </a>
                  <pre id='M000420-source'><span class="ruby-comment cmt"># File lib/spiderfw/model/mappers/mapper.rb, line 142</span>&#x000A;        <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">before_insert</span>(<span class="ruby-identifier">obj</span>)&#x000A;        <span class="ruby-keyword kw">end</span></pre>
                </div>
              </div>
              <div class='public-instance method' id='method-M000419'>
                <a name='M000419'>      </a>
                <div class='synopsis'>
                  <span class='name'>before_save</span>
                  <span class='arguments'>(obj, mode)</span>
                </div>
                <div class='description'>
                  <p>
                  This method is called before a save operation, normalizing and preparing
                  the object. &#8216;mode&#8217; can be :insert or :update. This method is
                  well suited for being overridden, to add custom preprocessing of the
                  object; just remember to call super, or use <a
                  href="Mapper.html#M000420">before_insert</a> and <a
                  href="Mapper.html#M000421">before_update</a> instead.
                  </p>
                </div>
                <div class='source'>
                  <a class='source-toggle' href='#' onclick="toggleCode('M000419-source'); return false">
                    [show source]
                  </a>
                  <pre id='M000419-source'><span class="ruby-comment cmt"># File lib/spiderfw/model/mappers/mapper.rb, line 101</span>&#x000A;        <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">before_save</span>(<span class="ruby-identifier">obj</span>, <span class="ruby-identifier">mode</span>)&#x000A;            <span class="ruby-identifier">normalize</span>(<span class="ruby-identifier">obj</span>)&#x000A;            <span class="ruby-keyword kw">if</span> (<span class="ruby-identifier">mode</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">:insert</span>)&#x000A;                <span class="ruby-identifier">before_insert</span>(<span class="ruby-identifier">obj</span>)&#x000A;            <span class="ruby-keyword kw">elsif</span> (<span class="ruby-identifier">mode</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">:update</span>)&#x000A;                <span class="ruby-identifier">before_update</span>(<span class="ruby-identifier">obj</span>)&#x000A;            <span class="ruby-keyword kw">end</span>&#x000A;            <span class="ruby-ivar">@model</span>.<span class="ruby-identifier">elements_array</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">el</span><span class="ruby-operator">|</span>&#x000A;                <span class="ruby-keyword kw">if</span> (<span class="ruby-identifier">el</span>.<span class="ruby-identifier">attributes</span>[<span class="ruby-identifier">:set_before_save</span>])&#x000A;                    <span class="ruby-identifier">set_data</span> = <span class="ruby-identifier">el</span>.<span class="ruby-identifier">attributes</span>[<span class="ruby-identifier">:set_before_save</span>]&#x000A;                    <span class="ruby-keyword kw">if</span> (<span class="ruby-identifier">el</span>.<span class="ruby-identifier">model?</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">set_data</span>.<span class="ruby-identifier">is_a?</span>(<span class="ruby-constant">Hash</span>))&#x000A;                        <span class="ruby-keyword kw">if</span> (<span class="ruby-identifier">obj</span>.<span class="ruby-identifier">element_has_value?</span>(<span class="ruby-identifier">el</span>))&#x000A;                            <span class="ruby-identifier">set_data</span>.<span class="ruby-identifier">each</span>{ <span class="ruby-operator">|</span><span class="ruby-identifier">k</span>, <span class="ruby-identifier">v</span><span class="ruby-operator">|</span> <span class="ruby-identifier">obj</span>.<span class="ruby-identifier">get</span>(<span class="ruby-identifier">el</span>).<span class="ruby-identifier">set</span>(<span class="ruby-identifier">k</span>, <span class="ruby-identifier">v</span>) }&#x000A;                        <span class="ruby-keyword kw">else</span>&#x000A;                            <span class="ruby-identifier">obj</span>.<span class="ruby-identifier">set</span>(<span class="ruby-identifier">el</span>, <span class="ruby-identifier">el</span>.<span class="ruby-identifier">model</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">set_data</span>))&#x000A;                        <span class="ruby-keyword kw">end</span> &#x000A;                    <span class="ruby-keyword kw">else</span>&#x000A;                        <span class="ruby-identifier">obj</span>.<span class="ruby-identifier">set</span>(<span class="ruby-identifier">el</span>, <span class="ruby-identifier">set_data</span>)&#x000A;                    <span class="ruby-keyword kw">end</span>&#x000A;                <span class="ruby-keyword kw">end</span>&#x000A;                <span class="ruby-identifier">raise</span> <span class="ruby-constant">RequiredError</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">el</span>) <span class="ruby-keyword kw">if</span> (<span class="ruby-identifier">el</span>.<span class="ruby-identifier">required?</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">obj</span>.<span class="ruby-identifier">element_modified?</span>(<span class="ruby-identifier">el</span>) <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-operator">!</span><span class="ruby-identifier">obj</span>.<span class="ruby-identifier">element_has_value?</span>(<span class="ruby-identifier">el</span>))&#x000A;                <span class="ruby-keyword kw">if</span> (<span class="ruby-identifier">el</span>.<span class="ruby-identifier">unique?</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-operator">!</span><span class="ruby-identifier">el</span>.<span class="ruby-identifier">integrated?</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">obj</span>.<span class="ruby-identifier">element_modified?</span>(<span class="ruby-identifier">el</span>))&#x000A;                    <span class="ruby-identifier">existent</span> = <span class="ruby-ivar">@model</span>.<span class="ruby-identifier">where</span>(<span class="ruby-identifier">el</span>.<span class="ruby-identifier">name</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">obj</span>.<span class="ruby-identifier">get</span>(<span class="ruby-identifier">el</span>))&#x000A;                    <span class="ruby-keyword kw">if</span> (<span class="ruby-identifier">mode</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">:insert</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">existent</span>.<span class="ruby-identifier">length</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">0</span>) <span class="ruby-operator">||</span> (<span class="ruby-identifier">mode</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">:update</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">existent</span>.<span class="ruby-identifier">length</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">1</span>)&#x000A;                        <span class="ruby-identifier">raise</span> <span class="ruby-constant">NotUniqueError</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">el</span>)&#x000A;                    <span class="ruby-keyword kw">end</span>&#x000A;                <span class="ruby-keyword kw">end</span>&#x000A;            <span class="ruby-keyword kw">end</span>&#x000A;            <span class="ruby-keyword kw">if</span> (<span class="ruby-ivar">@model</span>.<span class="ruby-identifier">extended_models</span>)&#x000A;                <span class="ruby-ivar">@model</span>.<span class="ruby-identifier">extended_models</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">m</span>, <span class="ruby-identifier">el</span><span class="ruby-operator">|</span>&#x000A;                    <span class="ruby-identifier">obj</span>.<span class="ruby-identifier">instantiate_element</span>(<span class="ruby-identifier">el</span>) <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">obj</span>.<span class="ruby-identifier">get</span>(<span class="ruby-identifier">el</span>)&#x000A;                    <span class="ruby-identifier">obj</span>.<span class="ruby-identifier">get</span>(<span class="ruby-identifier">el</span>).<span class="ruby-identifier">save</span> <span class="ruby-keyword kw">if</span> (<span class="ruby-identifier">obj</span>.<span class="ruby-identifier">element_modified?</span>(<span class="ruby-identifier">el</span>) <span class="ruby-operator">||</span> <span class="ruby-operator">!</span><span class="ruby-identifier">obj</span>.<span class="ruby-identifier">primary_keys_set?</span>) <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">obj</span>.<span class="ruby-identifier">get</span>(<span class="ruby-identifier">el</span>).<span class="ruby-identifier">mapper</span>.<span class="ruby-identifier">class</span>.<span class="ruby-identifier">write?</span>&#x000A;                <span class="ruby-keyword kw">end</span>&#x000A;            <span class="ruby-keyword kw">end</span>&#x000A;            <span class="ruby-ivar">@model</span>.<span class="ruby-identifier">elements_array</span>.<span class="ruby-identifier">select</span>{ <span class="ruby-operator">|</span><span class="ruby-identifier">el</span><span class="ruby-operator">|</span> <span class="ruby-identifier">el</span>.<span class="ruby-identifier">attributes</span>[<span class="ruby-identifier">:integrated_model</span>] }.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">el</span><span class="ruby-operator">|</span>&#x000A;                <span class="ruby-identifier">obj</span>.<span class="ruby-identifier">get</span>(<span class="ruby-identifier">el</span>).<span class="ruby-identifier">save</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">obj</span>.<span class="ruby-identifier">element_modified?</span>(<span class="ruby-identifier">el</span>) <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">obj</span>.<span class="ruby-identifier">get</span>(<span class="ruby-identifier">el</span>).<span class="ruby-identifier">mapper</span>.<span class="ruby-identifier">class</span>.<span class="ruby-identifier">write?</span>&#x000A;            <span class="ruby-keyword kw">end</span>&#x000A;&#x000A;        <span class="ruby-keyword kw">end</span></pre>
                </div>
              </div>
              <div class='public-instance method' id='method-M000421'>
                <a name='M000421'>      </a>
                <div class='synopsis'>
                  <span class='name'>before_update</span>
                  <span class='arguments'>(obj)</span>
                </div>
                <div class='description'>
                  <p>
                  Hook to provide custom preprocessing. The default implementation does
                  nothing.
                  </p>
                </div>
                <div class='source'>
                  <a class='source-toggle' href='#' onclick="toggleCode('M000421-source'); return false">
                    [show source]
                  </a>
                  <pre id='M000421-source'><span class="ruby-comment cmt"># File lib/spiderfw/model/mappers/mapper.rb, line 146</span>&#x000A;        <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">before_update</span>(<span class="ruby-identifier">obj</span>)&#x000A;        <span class="ruby-keyword kw">end</span></pre>
                </div>
              </div>
              <div class='public-instance method' id='method-M000443'>
                <a name='M000443'>      </a>
                <div class='synopsis'>
                  <span class='name'>count</span>
                  <span class='arguments'>(condition)</span>
                </div>
                <div class='description'>
                  <p>
                  Does a count query on the storage for given condition
                  </p>
                </div>
                <div class='source'>
                  <a class='source-toggle' href='#' onclick="toggleCode('M000443-source'); return false">
                    [show source]
                  </a>
                  <pre id='M000443-source'><span class="ruby-comment cmt"># File lib/spiderfw/model/mappers/mapper.rb, line 429</span>&#x000A;        <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">count</span>(<span class="ruby-identifier">condition</span>)&#x000A;            <span class="ruby-identifier">query</span> = <span class="ruby-constant">Query</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">condition</span>)&#x000A;            <span class="ruby-identifier">result</span> = <span class="ruby-identifier">fetch</span>(<span class="ruby-identifier">query</span>)&#x000A;            <span class="ruby-keyword kw">return</span> <span class="ruby-identifier">result</span>.<span class="ruby-identifier">length</span>&#x000A;        <span class="ruby-keyword kw">end</span></pre>
                </div>
              </div>
              <div class='public-instance method' id='method-M000431'>
                <a name='M000431'>      </a>
                <div class='synopsis'>
                  <span class='name'>delete</span>
                  <span class='arguments'>(obj_or_condition, force=false)</span>
                </div>
                <div class='description'>
                  <p>
                  Deletes an object, or objects according to a condition. Will not delete
                  with null condition (i.e. all objects) unless force is true
                  </p>
                </div>
                <div class='source'>
                  <a class='source-toggle' href='#' onclick="toggleCode('M000431-source'); return false">
                    [show source]
                  </a>
                  <pre id='M000431-source'><span class="ruby-comment cmt"># File lib/spiderfw/model/mappers/mapper.rb, line 267</span>&#x000A;        <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">delete</span>(<span class="ruby-identifier">obj_or_condition</span>, <span class="ruby-identifier">force</span>=<span class="ruby-keyword kw">false</span>)&#x000A;            &#x000A;            <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">prepare_delete_condition</span>(<span class="ruby-identifier">obj</span>)&#x000A;                <span class="ruby-identifier">condition</span> = <span class="ruby-constant">Condition</span>.<span class="ruby-identifier">and</span>&#x000A;                <span class="ruby-ivar">@model</span>.<span class="ruby-identifier">primary_keys</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">key</span><span class="ruby-operator">|</span>&#x000A;                    <span class="ruby-identifier">condition</span>[<span class="ruby-identifier">key</span>.<span class="ruby-identifier">name</span>] = <span class="ruby-identifier">map_condition_value</span>(<span class="ruby-identifier">key</span>.<span class="ruby-identifier">type</span>, <span class="ruby-identifier">obj</span>.<span class="ruby-identifier">get</span>(<span class="ruby-identifier">key</span>))&#x000A;                <span class="ruby-keyword kw">end</span>&#x000A;                <span class="ruby-keyword kw">return</span> <span class="ruby-identifier">condition</span>&#x000A;            <span class="ruby-keyword kw">end</span>&#x000A;            &#x000A;            <span class="ruby-identifier">storage</span>.<span class="ruby-identifier">start_transaction</span>&#x000A;            <span class="ruby-keyword kw">if</span> (<span class="ruby-identifier">obj_or_condition</span>.<span class="ruby-identifier">is_a?</span>(<span class="ruby-constant">BaseModel</span>))&#x000A;                <span class="ruby-identifier">condition</span> = <span class="ruby-identifier">prepare_delete_condition</span>(<span class="ruby-identifier">obj_or_condition</span>)&#x000A;            <span class="ruby-keyword kw">elsif</span> (<span class="ruby-identifier">obj_or_condition</span>.<span class="ruby-identifier">is_a?</span>(<span class="ruby-constant">QuerySet</span>))&#x000A;                <span class="ruby-identifier">qs</span> = <span class="ruby-identifier">obj_or_condition</span>&#x000A;                <span class="ruby-identifier">condition</span> = <span class="ruby-constant">Condition</span>.<span class="ruby-identifier">or</span>&#x000A;                <span class="ruby-identifier">qs</span>.<span class="ruby-identifier">each</span>{ <span class="ruby-operator">|</span><span class="ruby-identifier">obj</span><span class="ruby-operator">|</span> <span class="ruby-identifier">condition</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">prepare_delete_condition</span>(<span class="ruby-identifier">obj</span>) }&#x000A;            <span class="ruby-keyword kw">else</span>&#x000A;                <span class="ruby-identifier">condition</span> = <span class="ruby-identifier">obj_or_condition</span>.<span class="ruby-identifier">is_a?</span>(<span class="ruby-constant">Condition</span>) <span class="ruby-operator">?</span> <span class="ruby-identifier">obj_or_condition</span> <span class="ruby-operator">:</span> <span class="ruby-constant">Condition</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">obj_or_condition</span>)&#x000A;            <span class="ruby-keyword kw">end</span>&#x000A;            <span class="ruby-constant">Spider</span><span class="ruby-operator">::</span><span class="ruby-constant">Logger</span>.<span class="ruby-identifier">debug</span>(<span class="ruby-value str">&quot;Deleting with condition:&quot;</span>)&#x000A;            <span class="ruby-constant">Spider</span><span class="ruby-operator">::</span><span class="ruby-constant">Logger</span>.<span class="ruby-identifier">debug</span>(<span class="ruby-identifier">condition</span>)&#x000A;            <span class="ruby-identifier">prepare_query_condition</span>(<span class="ruby-identifier">condition</span>)&#x000A;            <span class="ruby-identifier">cascade</span> = <span class="ruby-ivar">@model</span>.<span class="ruby-identifier">elements_array</span>.<span class="ruby-identifier">select</span>{ <span class="ruby-operator">|</span><span class="ruby-identifier">el</span><span class="ruby-operator">|</span> <span class="ruby-identifier">el</span>.<span class="ruby-identifier">attributes</span>[<span class="ruby-identifier">:delete_cascade</span>] }&#x000A;            <span class="ruby-identifier">assocs</span> = <span class="ruby-identifier">association_elements</span>.<span class="ruby-identifier">select</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">el</span><span class="ruby-operator">|</span>&#x000A;                <span class="ruby-operator">!</span><span class="ruby-identifier">storage</span>.<span class="ruby-identifier">supports?</span>(<span class="ruby-identifier">:delete_cascade</span>) <span class="ruby-operator">||</span> <span class="ruby-operator">!</span><span class="ruby-identifier">schema</span>.<span class="ruby-identifier">cascade?</span>(<span class="ruby-identifier">el</span>.<span class="ruby-identifier">name</span>) <span class="ruby-comment cmt"># TODO: implement</span>&#x000A;            <span class="ruby-keyword kw">end</span>&#x000A;            <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">cascade</span>.<span class="ruby-identifier">empty?</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">assocs</span>.<span class="ruby-identifier">empty?</span>&#x000A;                <span class="ruby-identifier">curr</span> = <span class="ruby-identifier">find</span>(<span class="ruby-constant">Query</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">condition</span>))&#x000A;                <span class="ruby-identifier">curr</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">curr_obj</span><span class="ruby-operator">|</span>&#x000A;                    <span class="ruby-identifier">cascade</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">el</span><span class="ruby-operator">|</span>&#x000A;                        <span class="ruby-identifier">el</span>.<span class="ruby-identifier">model</span>.<span class="ruby-identifier">mapper</span>.<span class="ruby-identifier">delete</span>(<span class="ruby-identifier">curr_obj</span>.<span class="ruby-identifier">get</span>(<span class="ruby-identifier">el</span>))&#x000A;                    <span class="ruby-keyword kw">end</span>&#x000A;                    <span class="ruby-identifier">assocs</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">el</span><span class="ruby-operator">|</span>&#x000A;                        <span class="ruby-identifier">delete_element_associations</span>(<span class="ruby-identifier">curr_obj</span>, <span class="ruby-identifier">el</span>)&#x000A;                    <span class="ruby-keyword kw">end</span>&#x000A;                <span class="ruby-keyword kw">end</span>&#x000A;            <span class="ruby-keyword kw">end</span>&#x000A;            <span class="ruby-identifier">do_delete</span>(<span class="ruby-identifier">condition</span>, <span class="ruby-identifier">force</span>)&#x000A;            <span class="ruby-identifier">storage</span>.<span class="ruby-identifier">commit</span>&#x000A;        <span class="ruby-keyword kw">end</span></pre>
                </div>
              </div>
              <div class='public-instance method' id='method-M000433'>
                <a name='M000433'>      </a>
                <div class='synopsis'>
                  <span class='name'>delete_all!</span>
                  <span class='arguments'>()</span>
                </div>
                <div class='description'>
                  <p>
                  Deletes all objects from the storage.
                  </p>
                </div>
                <div class='source'>
                  <a class='source-toggle' href='#' onclick="toggleCode('M000433-source'); return false">
                    [show source]
                  </a>
                  <pre id='M000433-source'><span class="ruby-comment cmt"># File lib/spiderfw/model/mappers/mapper.rb, line 310</span>&#x000A;        <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">delete_all!</span>&#x000A;            <span class="ruby-identifier">all</span> = <span class="ruby-ivar">@model</span>.<span class="ruby-identifier">all</span>&#x000A;            <span class="ruby-comment cmt">#all.fetch_window = 100</span>&#x000A;            <span class="ruby-identifier">delete</span>(<span class="ruby-identifier">all</span>, <span class="ruby-keyword kw">true</span>)&#x000A;        <span class="ruby-keyword kw">end</span></pre>
                </div>
              </div>
              <div class='public-instance method' id='method-M000426'>
                <a name='M000426'>      </a>
                <div class='synopsis'>
                  <span class='name'>delete_element_associations</span>
                  <span class='arguments'>(obj, element)</span>
                </div>
                <div class='description'>
                  <p>
                  Deletes all associations from the given object to the element.
                  </p>
                </div>
                <div class='source'>
                  <a class='source-toggle' href='#' onclick="toggleCode('M000426-source'); return false">
                    [show source]
                  </a>
                  <pre id='M000426-source'><span class="ruby-comment cmt"># File lib/spiderfw/model/mappers/mapper.rb, line 198</span>&#x000A;        <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">delete_element_associations</span>(<span class="ruby-identifier">obj</span>, <span class="ruby-identifier">element</span>)&#x000A;            <span class="ruby-keyword kw">if</span> (<span class="ruby-identifier">element</span>.<span class="ruby-identifier">attributes</span>[<span class="ruby-identifier">:junction</span>])&#x000A;                <span class="ruby-identifier">element</span>.<span class="ruby-identifier">mapper</span>.<span class="ruby-identifier">delete</span>({<span class="ruby-identifier">element</span>.<span class="ruby-identifier">attributes</span>[<span class="ruby-identifier">:reverse</span>] =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">obj</span>.<span class="ruby-identifier">primary_keys</span>})&#x000A;            <span class="ruby-keyword kw">else</span>&#x000A;                <span class="ruby-identifier">associated</span> = <span class="ruby-identifier">obj</span>.<span class="ruby-identifier">get</span>(<span class="ruby-identifier">element</span>)&#x000A;                <span class="ruby-keyword kw">if</span> (<span class="ruby-identifier">element</span>.<span class="ruby-identifier">multiple?</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">element</span>.<span class="ruby-identifier">owned?</span>)&#x000A;                    <span class="ruby-identifier">condition</span> = <span class="ruby-constant">Condition</span>.<span class="ruby-identifier">and</span>&#x000A;                    <span class="ruby-identifier">associated</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">child</span><span class="ruby-operator">|</span>&#x000A;                        <span class="ruby-identifier">condition_row</span> = <span class="ruby-constant">Condition</span>.<span class="ruby-identifier">or</span>&#x000A;                        <span class="ruby-identifier">element</span>.<span class="ruby-identifier">model</span>.<span class="ruby-identifier">primary_keys</span>.<span class="ruby-identifier">each</span>{ <span class="ruby-operator">|</span><span class="ruby-identifier">el</span><span class="ruby-operator">|</span> <span class="ruby-identifier">condition_row</span>.<span class="ruby-identifier">set</span>(<span class="ruby-identifier">el</span>.<span class="ruby-identifier">name</span>, <span class="ruby-value str">'&lt;&gt;'</span>, <span class="ruby-identifier">child</span>.<span class="ruby-identifier">get</span>(<span class="ruby-identifier">el</span>))}&#x000A;                        <span class="ruby-identifier">condition</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">condition_row</span>&#x000A;                    <span class="ruby-keyword kw">end</span>&#x000A;                    <span class="ruby-identifier">element</span>.<span class="ruby-identifier">mapper</span>.<span class="ruby-identifier">delete</span>(<span class="ruby-identifier">condition</span>)&#x000A;                <span class="ruby-keyword kw">end</span>&#x000A;            <span class="ruby-keyword kw">end</span>&#x000A;        <span class="ruby-keyword kw">end</span></pre>
                </div>
              </div>
              <div class='public-instance method' id='method-M000434'>
                <a name='M000434'>      </a>
                <div class='synopsis'>
                  <span class='name'>do_delete</span>
                  <span class='arguments'>(obj, force=false)</span>
                </div>
                <div class='description'>
                  <p>
                  Actual interaction with the storage. May be implemented by subclasses.
                  </p>
                </div>
                <div class='source'>
                  <a class='source-toggle' href='#' onclick="toggleCode('M000434-source'); return false">
                    [show source]
                  </a>
                  <pre id='M000434-source'><span class="ruby-comment cmt"># File lib/spiderfw/model/mappers/mapper.rb, line 317</span>&#x000A;        <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">do_delete</span>(<span class="ruby-identifier">obj</span>, <span class="ruby-identifier">force</span>=<span class="ruby-keyword kw">false</span>)&#x000A;            <span class="ruby-identifier">raise</span> <span class="ruby-constant">MapperError</span>, <span class="ruby-value str">&quot;Unimplemented&quot;</span>&#x000A;        <span class="ruby-keyword kw">end</span></pre>
                </div>
              </div>
              <div class='public-instance method' id='method-M000435'>
                <a name='M000435'>      </a>
                <div class='synopsis'>
                  <span class='name'>do_insert</span>
                  <span class='arguments'>(obj)</span>
                </div>
                <div class='description'>
                  <p>
                  Actual interaction with the storage. May be implemented by subclasses.
                  </p>
                </div>
                <div class='source'>
                  <a class='source-toggle' href='#' onclick="toggleCode('M000435-source'); return false">
                    [show source]
                  </a>
                  <pre id='M000435-source'><span class="ruby-comment cmt"># File lib/spiderfw/model/mappers/mapper.rb, line 322</span>&#x000A;        <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">do_insert</span>(<span class="ruby-identifier">obj</span>)&#x000A;            <span class="ruby-identifier">raise</span> <span class="ruby-constant">MapperError</span>, <span class="ruby-value str">&quot;Unimplemented&quot;</span>&#x000A;        <span class="ruby-keyword kw">end</span></pre>
                </div>
              </div>
              <div class='public-instance method' id='method-M000436'>
                <a name='M000436'>      </a>
                <div class='synopsis'>
                  <span class='name'>do_update</span>
                  <span class='arguments'>(obj)</span>
                </div>
                <div class='description'>
                  <p>
                  Actual interaction with the storage. May be implemented by subclasses.
                  </p>
                </div>
                <div class='source'>
                  <a class='source-toggle' href='#' onclick="toggleCode('M000436-source'); return false">
                    [show source]
                  </a>
                  <pre id='M000436-source'><span class="ruby-comment cmt"># File lib/spiderfw/model/mappers/mapper.rb, line 327</span>&#x000A;        <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">do_update</span>(<span class="ruby-identifier">obj</span>)&#x000A;            <span class="ruby-identifier">raise</span> <span class="ruby-constant">MapperError</span>, <span class="ruby-value str">&quot;Unimplemented&quot;</span>&#x000A;        <span class="ruby-keyword kw">end</span></pre>
                </div>
              </div>
              <div class='public-instance method' id='method-M000452'>
                <a name='M000452'>      </a>
                <div class='synopsis'>
                  <span class='name'>expand_request</span>
                  <span class='arguments'>(request, obj=nil)</span>
                </div>
                <div class='description'>
                  <p>
                  Adds lazy groups to request.
                  </p>
                </div>
                <div class='source'>
                  <a class='source-toggle' href='#' onclick="toggleCode('M000452-source'); return false">
                    [show source]
                  </a>
                  <pre id='M000452-source'><span class="ruby-comment cmt"># File lib/spiderfw/model/mappers/mapper.rb, line 577</span>&#x000A;        <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">expand_request</span>(<span class="ruby-identifier">request</span>, <span class="ruby-identifier">obj</span>=<span class="ruby-keyword kw">nil</span>)&#x000A;            <span class="ruby-identifier">lazy_groups</span> = []&#x000A;            <span class="ruby-identifier">request</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">k</span>, <span class="ruby-identifier">v</span><span class="ruby-operator">|</span>&#x000A;                <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">element</span> = <span class="ruby-ivar">@model</span>.<span class="ruby-identifier">elements</span>[<span class="ruby-identifier">k</span>]&#x000A;                    <span class="ruby-identifier">request</span>.<span class="ruby-identifier">delete</span>(<span class="ruby-identifier">k</span>)&#x000A;                    <span class="ruby-keyword kw">next</span>&#x000A;                <span class="ruby-keyword kw">end</span>&#x000A;                <span class="ruby-identifier">grps</span> = <span class="ruby-identifier">element</span>.<span class="ruby-identifier">lazy_groups</span>&#x000A;                <span class="ruby-identifier">lazy_groups</span> <span class="ruby-operator">+=</span> <span class="ruby-identifier">grps</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">grps</span>&#x000A;            <span class="ruby-keyword kw">end</span>&#x000A;            <span class="ruby-identifier">lazy_groups</span>.<span class="ruby-identifier">uniq!</span>&#x000A;            <span class="ruby-ivar">@model</span>.<span class="ruby-identifier">elements</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">name</span>, <span class="ruby-identifier">element</span><span class="ruby-operator">|</span>&#x000A;                <span class="ruby-keyword kw">next</span> <span class="ruby-keyword kw">if</span> (<span class="ruby-identifier">obj</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">obj</span>.<span class="ruby-identifier">element_loaded?</span>(<span class="ruby-identifier">name</span>))&#x000A;                <span class="ruby-keyword kw">if</span> (<span class="ruby-identifier">element</span>.<span class="ruby-identifier">lazy_groups</span> <span class="ruby-operator">&amp;&amp;</span> (<span class="ruby-identifier">lazy_groups</span> <span class="ruby-operator">-</span> <span class="ruby-identifier">element</span>.<span class="ruby-identifier">lazy_groups</span>).<span class="ruby-identifier">length</span> <span class="ruby-operator">&lt;</span> <span class="ruby-identifier">lazy_groups</span>.<span class="ruby-identifier">length</span>)&#x000A;                    <span class="ruby-identifier">request</span>.<span class="ruby-identifier">request</span>(<span class="ruby-identifier">name</span>)&#x000A;                <span class="ruby-keyword kw">end</span>&#x000A;            <span class="ruby-keyword kw">end</span>&#x000A;        <span class="ruby-keyword kw">end</span></pre>
                </div>
              </div>
              <div class='public-instance method' id='method-M000444'>
                <a name='M000444'>      </a>
                <div class='synopsis'>
                  <span class='name'>fetch</span>
                  <span class='arguments'>(query)</span>
                </div>
                <div class='description'>
                  <p>
                  Actual interaction with the storage. Should be implemented by subclasses.
                  </p>
                </div>
                <div class='source'>
                  <a class='source-toggle' href='#' onclick="toggleCode('M000444-source'); return false">
                    [show source]
                  </a>
                  <pre id='M000444-source'><span class="ruby-comment cmt"># File lib/spiderfw/model/mappers/mapper.rb, line 436</span>&#x000A;        <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">fetch</span>(<span class="ruby-identifier">query</span>)&#x000A;            <span class="ruby-identifier">raise</span> <span class="ruby-constant">MapperError</span>, <span class="ruby-value str">&quot;Unimplemented&quot;</span>&#x000A;        <span class="ruby-keyword kw">end</span></pre>
                </div>
              </div>
              <div class='public-instance method' id='method-M000442'>
                <a name='M000442'>      </a>
                <div class='synopsis'>
                  <span class='name'>find</span>
                  <span class='arguments'>(query, query_set=nil, options={})</span>
                </div>
                <div class='description'>
                  <p>
                  Finds objects according to a query, merging the results into a query_set if
                  given.
                  </p>
                </div>
                <div class='source'>
                  <a class='source-toggle' href='#' onclick="toggleCode('M000442-source'); return false">
                    [show source]
                  </a>
                  <pre id='M000442-source'><span class="ruby-comment cmt"># File lib/spiderfw/model/mappers/mapper.rb, line 367</span>&#x000A;        <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">find</span>(<span class="ruby-identifier">query</span>, <span class="ruby-identifier">query_set</span>=<span class="ruby-keyword kw">nil</span>, <span class="ruby-identifier">options</span>={})&#x000A;            <span class="ruby-identifier">set</span> = <span class="ruby-keyword kw">nil</span>&#x000A;            <span class="ruby-constant">Spider</span><span class="ruby-operator">::</span><span class="ruby-constant">Model</span>.<span class="ruby-identifier">with_identity_mapper</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">im</span><span class="ruby-operator">|</span>&#x000A;<span class="ruby-comment cmt">#                im.put(query_set)</span>&#x000A;                <span class="ruby-keyword kw">if</span> (<span class="ruby-ivar">@model</span>.<span class="ruby-identifier">attributes</span>[<span class="ruby-identifier">:condition</span>])&#x000A;                    <span class="ruby-identifier">query</span>.<span class="ruby-identifier">condition</span> = <span class="ruby-constant">Condition</span>.<span class="ruby-identifier">and</span>(<span class="ruby-identifier">query</span>.<span class="ruby-identifier">condition</span>, <span class="ruby-ivar">@model</span>.<span class="ruby-identifier">attributes</span>[<span class="ruby-identifier">:condition</span>])&#x000A;                <span class="ruby-keyword kw">end</span>&#x000A;                <span class="ruby-ivar">@model</span>.<span class="ruby-identifier">primary_keys</span>.<span class="ruby-identifier">each</span>{ <span class="ruby-operator">|</span><span class="ruby-identifier">key</span><span class="ruby-operator">|</span> <span class="ruby-identifier">query</span>.<span class="ruby-identifier">request</span>[<span class="ruby-identifier">key</span>] = <span class="ruby-keyword kw">true</span>}&#x000A;                <span class="ruby-identifier">expand_request</span>(<span class="ruby-identifier">query</span>.<span class="ruby-identifier">request</span>) <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">options</span>[<span class="ruby-identifier">:no_expand_request</span>]&#x000A;                <span class="ruby-identifier">query</span> = <span class="ruby-identifier">prepare_query</span>(<span class="ruby-identifier">query</span>, <span class="ruby-identifier">query_set</span>)&#x000A;                <span class="ruby-identifier">query</span>.<span class="ruby-identifier">request</span>.<span class="ruby-identifier">total_rows</span> = <span class="ruby-keyword kw">true</span> <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">query</span>.<span class="ruby-identifier">request</span>.<span class="ruby-identifier">total_rows</span> <span class="ruby-operator">==</span> <span class="ruby-keyword kw">false</span>&#x000A;                <span class="ruby-identifier">result</span> = <span class="ruby-identifier">fetch</span>(<span class="ruby-identifier">query</span>)&#x000A;                <span class="ruby-identifier">set</span> = <span class="ruby-identifier">query_set</span> <span class="ruby-operator">||</span> <span class="ruby-constant">QuerySet</span>.<span class="ruby-identifier">new</span>(<span class="ruby-ivar">@model</span>)&#x000A;                <span class="ruby-identifier">was_loaded</span> = <span class="ruby-identifier">set</span>.<span class="ruby-identifier">loaded</span>&#x000A;                <span class="ruby-identifier">set</span>.<span class="ruby-identifier">loaded</span> = <span class="ruby-keyword kw">true</span>&#x000A;                <span class="ruby-identifier">set</span>.<span class="ruby-identifier">index_by</span>(<span class="ruby-operator">*</span><span class="ruby-ivar">@model</span>.<span class="ruby-identifier">primary_keys</span>)&#x000A;                <span class="ruby-identifier">set</span>.<span class="ruby-identifier">last_query</span> = <span class="ruby-identifier">query</span>&#x000A;                <span class="ruby-keyword kw">if</span> <span class="ruby-operator">!</span><span class="ruby-identifier">result</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">result</span>.<span class="ruby-identifier">empty?</span>&#x000A;                    <span class="ruby-identifier">set</span>.<span class="ruby-identifier">each_current</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">obj</span><span class="ruby-operator">|</span>&#x000A;                        <span class="ruby-identifier">query</span>.<span class="ruby-identifier">request</span>.<span class="ruby-identifier">keys</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">element_name</span><span class="ruby-operator">|</span>&#x000A;                            <span class="ruby-identifier">obj</span>.<span class="ruby-identifier">set_loaded_value</span>(<span class="ruby-identifier">element_name</span>, <span class="ruby-keyword kw">nil</span>) <span class="ruby-keyword kw">unless</span> <span class="ruby-ivar">@model</span>.<span class="ruby-identifier">elements</span>[<span class="ruby-identifier">element_name</span>].<span class="ruby-identifier">integrated?</span>&#x000A;                        <span class="ruby-keyword kw">end</span>&#x000A;                    <span class="ruby-keyword kw">end</span>&#x000A;                    <span class="ruby-keyword kw">return</span> <span class="ruby-identifier">set</span>&#x000A;                <span class="ruby-keyword kw">end</span>&#x000A;                <span class="ruby-identifier">set</span>.<span class="ruby-identifier">total_rows</span> = <span class="ruby-identifier">result</span>.<span class="ruby-identifier">total_rows</span> <span class="ruby-keyword kw">if</span> (<span class="ruby-operator">!</span><span class="ruby-identifier">was_loaded</span>)&#x000A;                <span class="ruby-identifier">result</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">row</span><span class="ruby-operator">|</span>&#x000A;                    <span class="ruby-identifier">obj</span> =  <span class="ruby-identifier">map</span>(<span class="ruby-identifier">query</span>.<span class="ruby-identifier">request</span>, <span class="ruby-identifier">row</span>, <span class="ruby-identifier">set</span>.<span class="ruby-identifier">model</span>)&#x000A;                    <span class="ruby-keyword kw">next</span> <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">obj</span>&#x000A;                    <span class="ruby-identifier">search</span> = {} &#x000A;                    <span class="ruby-ivar">@model</span>.<span class="ruby-identifier">primary_keys</span>.<span class="ruby-identifier">each</span>{ <span class="ruby-operator">|</span><span class="ruby-identifier">k</span><span class="ruby-operator">|</span> <span class="ruby-identifier">search</span>[<span class="ruby-identifier">k</span>.<span class="ruby-identifier">name</span>] = <span class="ruby-identifier">obj</span>.<span class="ruby-identifier">get</span>(<span class="ruby-identifier">k</span>.<span class="ruby-identifier">name</span>) }&#x000A;                    <span class="ruby-identifier">obj_res</span> = <span class="ruby-identifier">set</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">search</span>)  <span class="ruby-comment cmt"># FIXME: find a better way</span>&#x000A;                    <span class="ruby-keyword kw">if</span> (<span class="ruby-identifier">obj_res</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">obj_res</span>[<span class="ruby-value">0</span>])&#x000A;                        <span class="ruby-identifier">obj_res</span>[<span class="ruby-value">0</span>].<span class="ruby-identifier">merge!</span>(<span class="ruby-identifier">obj</span>)&#x000A;                        <span class="ruby-identifier">obj</span>.<span class="ruby-identifier">loaded_elements</span>.<span class="ruby-identifier">each</span>{ <span class="ruby-operator">|</span><span class="ruby-identifier">name</span>, <span class="ruby-identifier">bool</span><span class="ruby-operator">|</span> <span class="ruby-identifier">set</span>.<span class="ruby-identifier">element_loaded</span>(<span class="ruby-identifier">name</span>) }&#x000A;                    <span class="ruby-keyword kw">else</span>&#x000A;                        <span class="ruby-identifier">set</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">obj</span>&#x000A;                    <span class="ruby-keyword kw">end</span>&#x000A;                    <span class="ruby-ivar">@raw_data</span>[<span class="ruby-identifier">obj</span>.<span class="ruby-identifier">object_id</span>] = <span class="ruby-identifier">row</span>&#x000A;                <span class="ruby-keyword kw">end</span>&#x000A;<span class="ruby-comment cmt">#                delay_put = true if (@model.primary_keys.select{ |k| @model.elements[k.name].integrated? }.length &gt; 0)</span>&#x000A;&#x000A;                <span class="ruby-identifier">set</span> = <span class="ruby-identifier">get_external</span>(<span class="ruby-identifier">set</span>, <span class="ruby-identifier">query</span>)&#x000A;                <span class="ruby-comment cmt"># FIXME: avoid the repetition</span>&#x000A;                <span class="ruby-identifier">set</span>.<span class="ruby-identifier">each_current</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">obj</span><span class="ruby-operator">|</span>&#x000A;                    <span class="ruby-identifier">query</span>.<span class="ruby-identifier">request</span>.<span class="ruby-identifier">keys</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">element_name</span><span class="ruby-operator">|</span>&#x000A;                        <span class="ruby-identifier">obj</span>.<span class="ruby-identifier">set_loaded_value</span>(<span class="ruby-identifier">element_name</span>, <span class="ruby-keyword kw">nil</span>) <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">obj</span>.<span class="ruby-identifier">element_loaded?</span>(<span class="ruby-identifier">element_name</span>) <span class="ruby-operator">||</span> <span class="ruby-ivar">@model</span>.<span class="ruby-identifier">elements</span>[<span class="ruby-identifier">element_name</span>].<span class="ruby-identifier">integrated?</span>&#x000A;                    <span class="ruby-keyword kw">end</span>&#x000A;                <span class="ruby-keyword kw">end</span>&#x000A;                <span class="ruby-comment cmt"># if (delay_put)</span>&#x000A;                <span class="ruby-comment cmt">#     set.no_autoload(false) do</span>&#x000A;                <span class="ruby-comment cmt">#         set.each_index do |i|</span>&#x000A;                <span class="ruby-comment cmt">#             set[i].primary_keys_set?</span>&#x000A;                <span class="ruby-comment cmt">#             set[i] = im.put(set[i], true)</span>&#x000A;                <span class="ruby-comment cmt">#         end</span>&#x000A;                <span class="ruby-comment cmt">#     end</span>&#x000A;                <span class="ruby-comment cmt"># end</span>&#x000A;            <span class="ruby-keyword kw">end</span>&#x000A;            <span class="ruby-keyword kw">return</span> <span class="ruby-identifier">set</span>&#x000A;        <span class="ruby-keyword kw">end</span></pre>
                </div>
              </div>
              <div class='public-instance method' id='method-M000454'>
                <a name='M000454'>      </a>
                <div class='synopsis'>
                  <span class='name'>get_dependencies</span>
                  <span class='arguments'>(obj, action)</span>
                </div>
                <div class='description'>
                  <p>
                  Returns task dependecies for the <a href="UnitOfWork.html">UnitOfWork</a>.
                  May be implemented by subclasses.
                  </p>
                </div>
                <div class='source'>
                  <a class='source-toggle' href='#' onclick="toggleCode('M000454-source'); return false">
                    [show source]
                  </a>
                  <pre id='M000454-source'><span class="ruby-comment cmt"># File lib/spiderfw/model/mappers/mapper.rb, line 628</span>&#x000A;        <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">get_dependencies</span>(<span class="ruby-identifier">obj</span>, <span class="ruby-identifier">action</span>)&#x000A;            <span class="ruby-keyword kw">return</span> []&#x000A;        <span class="ruby-keyword kw">end</span></pre>
                </div>
              </div>
              <div class='public-instance method' id='method-M000446'>
                <a name='M000446'>      </a>
                <div class='synopsis'>
                  <span class='name'>get_external</span>
                  <span class='arguments'>(objects, query)</span>
                </div>
                <div class='description'>
                  <p>
                  Loads external elements, according to query, and merges them into an object
                  or a <a href="QuerySet.html">QuerySet</a>
                  </p>
                </div>
                <div class='source'>
                  <a class='source-toggle' href='#' onclick="toggleCode('M000446-source'); return false">
                    [show source]
                  </a>
                  <pre id='M000446-source'><span class="ruby-comment cmt"># File lib/spiderfw/model/mappers/mapper.rb, line 447</span>&#x000A;        <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">get_external</span>(<span class="ruby-identifier">objects</span>, <span class="ruby-identifier">query</span>)&#x000A;            <span class="ruby-identifier">objects</span> = <span class="ruby-identifier">queryset_siblings</span>(<span class="ruby-identifier">objects</span>) <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">objects</span>.<span class="ruby-identifier">is_a?</span>(<span class="ruby-constant">QuerySet</span>)&#x000A;            <span class="ruby-keyword kw">return</span> <span class="ruby-identifier">objects</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">objects</span>.<span class="ruby-identifier">length</span> <span class="ruby-operator">&lt;</span> <span class="ruby-value">1</span>&#x000A;            <span class="ruby-identifier">got_external</span> = {}&#x000A;            <span class="ruby-identifier">get_integrated</span> = {}&#x000A;            <span class="ruby-identifier">query</span>.<span class="ruby-identifier">request</span>.<span class="ruby-identifier">each_key</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">element_name</span><span class="ruby-operator">|</span>&#x000A;                <span class="ruby-identifier">element</span> = <span class="ruby-ivar">@model</span>.<span class="ruby-identifier">elements</span>[<span class="ruby-identifier">element_name</span>]&#x000A;                <span class="ruby-keyword kw">next</span> <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">element</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">mapped?</span>(<span class="ruby-identifier">element</span>)&#x000A;                <span class="ruby-keyword kw">next</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">objects</span>.<span class="ruby-identifier">element_loaded?</span>(<span class="ruby-identifier">element_name</span>)&#x000A;                <span class="ruby-keyword kw">next</span> <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">element</span>.<span class="ruby-identifier">reverse</span> <span class="ruby-comment cmt"># FIXME</span>&#x000A;                <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">element</span>.<span class="ruby-identifier">integrated?</span>&#x000A;                   <span class="ruby-identifier">get_integrated</span>[<span class="ruby-identifier">element</span>.<span class="ruby-identifier">integrated_from</span>] <span class="ruby-operator">||=</span> <span class="ruby-constant">Request</span>.<span class="ruby-identifier">new</span>&#x000A;                   <span class="ruby-identifier">get_integrated</span>[<span class="ruby-identifier">element</span>.<span class="ruby-identifier">integrated_from</span>][<span class="ruby-identifier">element</span>.<span class="ruby-identifier">integrated_from_element</span>] = <span class="ruby-identifier">query</span>.<span class="ruby-identifier">request</span>[<span class="ruby-identifier">element_name</span>]&#x000A;                <span class="ruby-keyword kw">elsif</span> <span class="ruby-identifier">element</span>.<span class="ruby-identifier">model?</span>&#x000A;                    <span class="ruby-identifier">sub_query</span> = <span class="ruby-constant">Query</span>.<span class="ruby-identifier">new</span>&#x000A;                    <span class="ruby-identifier">sub_query</span>.<span class="ruby-identifier">request</span> = ( <span class="ruby-identifier">query</span>.<span class="ruby-identifier">request</span>[<span class="ruby-identifier">element_name</span>].<span class="ruby-identifier">class</span> <span class="ruby-operator">==</span> <span class="ruby-constant">Request</span> ) <span class="ruby-operator">?</span> <span class="ruby-identifier">query</span>.<span class="ruby-identifier">request</span>[<span class="ruby-identifier">element_name</span>] <span class="ruby-operator">:</span> <span class="ruby-keyword kw">nil</span>&#x000A;                    <span class="ruby-identifier">sub_query</span>.<span class="ruby-identifier">condition</span> = <span class="ruby-identifier">element</span>.<span class="ruby-identifier">attributes</span>[<span class="ruby-identifier">:condition</span>] <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">element</span>.<span class="ruby-identifier">attributes</span>[<span class="ruby-identifier">:condition</span>]&#x000A;                    <span class="ruby-identifier">got_external</span>[<span class="ruby-identifier">element</span>] = <span class="ruby-keyword kw">true</span>&#x000A;                    <span class="ruby-identifier">objects</span> = <span class="ruby-identifier">get_external_element</span>(<span class="ruby-identifier">element</span>, <span class="ruby-identifier">sub_query</span>, <span class="ruby-identifier">objects</span>)&#x000A;                <span class="ruby-keyword kw">end</span>&#x000A;                <span class="ruby-comment cmt"># no furter attempts to try; set as loaded</span>&#x000A;                <span class="ruby-identifier">objects</span>.<span class="ruby-identifier">element_loaded</span>(<span class="ruby-identifier">element_name</span>)&#x000A;            <span class="ruby-keyword kw">end</span>&#x000A;            <span class="ruby-identifier">get_integrated</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">integrated</span>, <span class="ruby-identifier">request</span><span class="ruby-operator">|</span>&#x000A;                <span class="ruby-keyword kw">next</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">got_external</span>[<span class="ruby-identifier">integrated</span>]&#x000A;                <span class="ruby-keyword kw">next</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">objects</span>.<span class="ruby-identifier">element_loaded?</span>(<span class="ruby-identifier">integrated</span>.<span class="ruby-identifier">name</span>)&#x000A;                <span class="ruby-identifier">sub_query</span> = <span class="ruby-constant">Query</span>.<span class="ruby-identifier">new</span>(<span class="ruby-keyword kw">nil</span>, <span class="ruby-identifier">request</span>)&#x000A;                <span class="ruby-identifier">objects</span> = <span class="ruby-identifier">get_external_element</span>(<span class="ruby-identifier">integrated</span>, <span class="ruby-identifier">sub_query</span>, <span class="ruby-identifier">objects</span>)&#x000A;                <span class="ruby-identifier">objects</span>.<span class="ruby-identifier">element_loaded</span>(<span class="ruby-identifier">integrated</span>)&#x000A;            <span class="ruby-keyword kw">end</span>&#x000A;            <span class="ruby-keyword kw">return</span> <span class="ruby-identifier">objects</span>&#x000A;        <span class="ruby-keyword kw">end</span></pre>
                </div>
              </div>
              <div class='public-instance method' id='method-M000447'>
                <a name='M000447'>      </a>
                <div class='synopsis'>
                  <span class='name'>get_external_element</span>
                  <span class='arguments'>(element, query, objects)</span>
                </div>
                <div class='description'>
                  <p>
                  Loads an external element, according to query, and merges the result into
                  an object or <a href="QuerySet.html">QuerySet</a>.
                  </p>
                </div>
                <div class='source'>
                  <a class='source-toggle' href='#' onclick="toggleCode('M000447-source'); return false">
                    [show source]
                  </a>
                  <pre id='M000447-source'><span class="ruby-comment cmt"># File lib/spiderfw/model/mappers/mapper.rb, line 481</span>&#x000A;        <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">get_external_element</span>(<span class="ruby-identifier">element</span>, <span class="ruby-identifier">query</span>, <span class="ruby-identifier">objects</span>)&#x000A;            <span class="ruby-constant">Spider</span><span class="ruby-operator">::</span><span class="ruby-constant">Logger</span>.<span class="ruby-identifier">debug</span>(<span class="ruby-node">&quot;Getting external element #{element.name} for #{@model}&quot;</span>)&#x000A;            <span class="ruby-keyword kw">if</span> (<span class="ruby-identifier">have_references?</span>(<span class="ruby-identifier">element</span>))&#x000A;                <span class="ruby-keyword kw">return</span> <span class="ruby-identifier">load_element</span>(<span class="ruby-identifier">objects</span>, <span class="ruby-identifier">element</span>)&#x000A;            <span class="ruby-keyword kw">end</span>&#x000A;            <span class="ruby-identifier">sub_request</span> = <span class="ruby-constant">Request</span>.<span class="ruby-identifier">new</span>&#x000A;            <span class="ruby-ivar">@model</span>.<span class="ruby-identifier">primary_keys</span>.<span class="ruby-identifier">each</span>{ <span class="ruby-operator">|</span><span class="ruby-identifier">key</span><span class="ruby-operator">|</span> <span class="ruby-identifier">sub_request</span>[<span class="ruby-identifier">key</span>.<span class="ruby-identifier">name</span>] = <span class="ruby-keyword kw">true</span> }&#x000A;            <span class="ruby-identifier">sub_request</span>[<span class="ruby-identifier">element</span>.<span class="ruby-identifier">attributes</span>[<span class="ruby-identifier">:reverse</span>]] = <span class="ruby-keyword kw">true</span>&#x000A;            <span class="ruby-identifier">condition</span> = <span class="ruby-constant">Condition</span>.<span class="ruby-identifier">or</span>&#x000A;            <span class="ruby-identifier">index_by</span> = []&#x000A;            <span class="ruby-ivar">@model</span>.<span class="ruby-identifier">primary_keys</span>.<span class="ruby-identifier">each</span>{ <span class="ruby-operator">|</span><span class="ruby-identifier">key</span><span class="ruby-operator">|</span> <span class="ruby-identifier">index_by</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">:&quot;#{element.attributes[:reverse]}.#{key.name}&quot;</span> }&#x000A;            &#x000A;<span class="ruby-comment cmt">#             if (@model.primary_keys.length == 1)</span>&#x000A;<span class="ruby-comment cmt">#                 pk = @model.primary_keys[0]</span>&#x000A;<span class="ruby-comment cmt">#                 a = objects.map{ |o| o.get(pk) }</span>&#x000A;<span class="ruby-comment cmt"># #                debugger</span>&#x000A;<span class="ruby-comment cmt">#                 condition[&quot;#{element.attributes[:reverse]}.#{pk.name}&quot;] = a</span>&#x000A;<span class="ruby-comment cmt">#             else</span>&#x000A;            <span class="ruby-identifier">seen_conditions</span> = {}&#x000A;            <span class="ruby-identifier">objects</span>.<span class="ruby-identifier">each_current</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">obj</span><span class="ruby-operator">|</span>&#x000A;<span class="ruby-comment cmt">#                if (@model.primary_keys.length == 1)</span>&#x000A;<span class="ruby-comment cmt">#                    condition</span>&#x000A;<span class="ruby-comment cmt">#                else</span>&#x000A;                <span class="ruby-identifier">condition_row</span> = <span class="ruby-constant">Condition</span>.<span class="ruby-identifier">and</span>&#x000A;                <span class="ruby-ivar">@model</span>.<span class="ruby-identifier">primary_keys</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">key</span><span class="ruby-operator">|</span>&#x000A;                    <span class="ruby-identifier">condition_row</span>[<span class="ruby-node">&quot;#{element.attributes[:reverse]}.#{key.name}&quot;</span>] = <span class="ruby-identifier">obj</span>.<span class="ruby-identifier">get</span>(<span class="ruby-identifier">key</span>)&#x000A;                <span class="ruby-keyword kw">end</span>&#x000A;                <span class="ruby-identifier">condition</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">condition_row</span> <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">seen_conditions</span>[<span class="ruby-identifier">condition_row</span>]&#x000A;                <span class="ruby-identifier">seen_conditions</span>[<span class="ruby-identifier">condition_row</span>] = <span class="ruby-keyword kw">true</span>&#x000A;<span class="ruby-comment cmt">#                end</span>&#x000A;            <span class="ruby-keyword kw">end</span>&#x000A;            <span class="ruby-identifier">seen_conditions</span> = <span class="ruby-keyword kw">nil</span>&#x000A;<span class="ruby-comment cmt">#            end</span>&#x000A;            <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">condition</span>.<span class="ruby-identifier">empty?</span>                &#x000A;                <span class="ruby-keyword kw">if</span> (<span class="ruby-identifier">element</span>.<span class="ruby-identifier">condition</span>)&#x000A;                    <span class="ruby-identifier">condition</span> = <span class="ruby-constant">Condition</span>.<span class="ruby-identifier">and</span>(<span class="ruby-identifier">condition</span>, <span class="ruby-identifier">element</span>.<span class="ruby-identifier">condition</span>)&#x000A;                <span class="ruby-keyword kw">end</span>&#x000A;                <span class="ruby-identifier">result</span> = <span class="ruby-constant">QuerySet</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">element</span>.<span class="ruby-identifier">model</span>).<span class="ruby-identifier">index_by</span>(<span class="ruby-operator">*</span><span class="ruby-identifier">index_by</span>)&#x000A;                <span class="ruby-identifier">result</span> = <span class="ruby-identifier">result</span>.<span class="ruby-identifier">mapper</span>.<span class="ruby-identifier">find</span>(<span class="ruby-constant">Query</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">condition</span>, <span class="ruby-identifier">sub_request</span>), <span class="ruby-identifier">result</span>)&#x000A;                <span class="ruby-identifier">result</span>.<span class="ruby-identifier">loaded</span> = <span class="ruby-keyword kw">true</span>&#x000A;                <span class="ruby-keyword kw">return</span> <span class="ruby-identifier">associate_external</span>(<span class="ruby-identifier">element</span>, <span class="ruby-identifier">objects</span>, <span class="ruby-identifier">result</span>)&#x000A;            <span class="ruby-keyword kw">end</span>&#x000A;            <span class="ruby-keyword kw">return</span> <span class="ruby-keyword kw">nil</span>&#x000A;        <span class="ruby-keyword kw">end</span></pre>
                </div>
              </div>
              <div class='public-instance method' id='method-M000418'>
                <a name='M000418'>      </a>
                <div class='synopsis'>
                  <span class='name'>have_references?</span>
                  <span class='arguments'>(element)</span>
                </div>
                <div class='description'>
                  <p>
                  Returns true if information to find the given element is accessible to the
                  mapper. (see for example DbMapper#have_references?)
                  </p>
                </div>
                <div class='source'>
                  <a class='source-toggle' href='#' onclick="toggleCode('M000418-source'); return false">
                    [show source]
                  </a>
                  <pre id='M000418-source'><span class="ruby-comment cmt"># File lib/spiderfw/model/mappers/mapper.rb, line 89</span>&#x000A;        <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">have_references?</span>(<span class="ruby-identifier">element</span>)&#x000A;            <span class="ruby-identifier">raise</span> <span class="ruby-constant">MapperError</span>, <span class="ruby-value str">&quot;Unimplemented&quot;</span>&#x000A;        <span class="ruby-keyword kw">end</span></pre>
                </div>
              </div>
              <div class='public-instance method' id='method-M000429'>
                <a name='M000429'>      </a>
                <div class='synopsis'>
                  <span class='name'>insert</span>
                  <span class='arguments'>(obj)</span>
                </div>
                <div class='description'>
                  <p>
                  Inserts the object in the storage.
                  </p>
                </div>
                <div class='source'>
                  <a class='source-toggle' href='#' onclick="toggleCode('M000429-source'); return false">
                    [show source]
                  </a>
                  <pre id='M000429-source'><span class="ruby-comment cmt"># File lib/spiderfw/model/mappers/mapper.rb, line 248</span>&#x000A;        <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">insert</span>(<span class="ruby-identifier">obj</span>)&#x000A;            <span class="ruby-identifier">before_save</span>(<span class="ruby-identifier">obj</span>, <span class="ruby-identifier">:insert</span>)&#x000A;            <span class="ruby-identifier">do_insert</span>(<span class="ruby-identifier">obj</span>)&#x000A;            <span class="ruby-identifier">after_save</span>(<span class="ruby-identifier">obj</span>, <span class="ruby-identifier">:insert</span>)&#x000A;        <span class="ruby-keyword kw">end</span></pre>
                </div>
              </div>
              <div class='public-instance method' id='method-M000441'>
                <a name='M000441'>      </a>
                <div class='synopsis'>
                  <span class='name'>load</span>
                  <span class='arguments'>(objects, query, options={})</span>
                </div>
                <div class='description'>
                  <p>
                  Loads elements of given objects according to query.request.
                  </p>
                </div>
                <div class='source'>
                  <a class='source-toggle' href='#' onclick="toggleCode('M000441-source'); return false">
                    [show source]
                  </a>
                  <pre id='M000441-source'><span class="ruby-comment cmt"># File lib/spiderfw/model/mappers/mapper.rb, line 356</span>&#x000A;        <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">load</span>(<span class="ruby-identifier">objects</span>, <span class="ruby-identifier">query</span>, <span class="ruby-identifier">options</span>={})&#x000A;            <span class="ruby-identifier">objects</span> = <span class="ruby-identifier">queryset_siblings</span>(<span class="ruby-identifier">objects</span>) <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">objects</span>.<span class="ruby-identifier">is_a?</span>(<span class="ruby-constant">QuerySet</span>)&#x000A;            <span class="ruby-identifier">request</span> = <span class="ruby-identifier">query</span>.<span class="ruby-identifier">request</span>&#x000A;            <span class="ruby-identifier">condition</span> = <span class="ruby-constant">Condition</span>.<span class="ruby-identifier">or</span>&#x000A;            <span class="ruby-identifier">objects</span>.<span class="ruby-identifier">each_current</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">obj</span><span class="ruby-operator">|</span>&#x000A;                <span class="ruby-identifier">condition</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">obj</span>.<span class="ruby-identifier">keys_to_condition</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">obj</span>.<span class="ruby-identifier">primary_keys_set?</span>&#x000A;            <span class="ruby-keyword kw">end</span>&#x000A;            <span class="ruby-keyword kw">return</span> <span class="ruby-identifier">find</span>(<span class="ruby-constant">Query</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">condition</span>, <span class="ruby-identifier">request</span>), <span class="ruby-identifier">objects</span>, <span class="ruby-identifier">options</span>)&#x000A;        <span class="ruby-keyword kw">end</span></pre>
                </div>
              </div>
              <div class='public-instance method' id='method-M000439'>
                <a name='M000439'>      </a>
                <div class='synopsis'>
                  <span class='name'>load_element</span>
                  <span class='arguments'>(objects, element)</span>
                </div>
                <div class='description'>
                  <p>
                  Loads an element. Other elements may be loaded as well, according to lazy
                  groups.
                  </p>
                </div>
                <div class='source'>
                  <a class='source-toggle' href='#' onclick="toggleCode('M000439-source'); return false">
                    [show source]
                  </a>
                  <pre id='M000439-source'><span class="ruby-comment cmt"># File lib/spiderfw/model/mappers/mapper.rb, line 346</span>&#x000A;        <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">load_element</span>(<span class="ruby-identifier">objects</span>, <span class="ruby-identifier">element</span>)&#x000A;            <span class="ruby-identifier">load</span>(<span class="ruby-identifier">objects</span>, <span class="ruby-constant">Query</span>.<span class="ruby-identifier">new</span>(<span class="ruby-keyword kw">nil</span>, [<span class="ruby-identifier">element</span>.<span class="ruby-identifier">name</span>]))&#x000A;        <span class="ruby-keyword kw">end</span></pre>
                </div>
              </div>
              <div class='public-instance method' id='method-M000440'>
                <a name='M000440'>      </a>
                <div class='synopsis'>
                  <span class='name'>load_element!</span>
                  <span class='arguments'>(objects, element)</span>
                </div>
                <div class='description'>
                  <p>
                  Loads only the given element, ignoring lazy groups.
                  </p>
                </div>
                <div class='source'>
                  <a class='source-toggle' href='#' onclick="toggleCode('M000440-source'); return false">
                    [show source]
                  </a>
                  <pre id='M000440-source'><span class="ruby-comment cmt"># File lib/spiderfw/model/mappers/mapper.rb, line 351</span>&#x000A;        <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">load_element!</span>(<span class="ruby-identifier">objects</span>, <span class="ruby-identifier">element</span>)&#x000A;            <span class="ruby-identifier">load</span>(<span class="ruby-identifier">objects</span>, <span class="ruby-constant">Query</span>.<span class="ruby-identifier">new</span>(<span class="ruby-keyword kw">nil</span>, [<span class="ruby-identifier">element</span>.<span class="ruby-identifier">name</span>]), <span class="ruby-identifier">:no_expand_request</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-keyword kw">true</span>)&#x000A;        <span class="ruby-keyword kw">end</span></pre>
                </div>
              </div>
              <div class='public-instance method' id='method-M000437'>
                <a name='M000437'>      </a>
                <div class='synopsis'>
                  <span class='name'>lock</span>
                  <span class='arguments'>(obj=nil, mode=:exclusive)</span>
                </div>
                <div class='description'>
                  <p>
                  Actual interaction with the storage. May be implemented by subclasses.
                  </p>
                </div>
                <div class='source'>
                  <a class='source-toggle' href='#' onclick="toggleCode('M000437-source'); return false">
                    [show source]
                  </a>
                  <pre id='M000437-source'><span class="ruby-comment cmt"># File lib/spiderfw/model/mappers/mapper.rb, line 332</span>&#x000A;        <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">lock</span>(<span class="ruby-identifier">obj</span>=<span class="ruby-keyword kw">nil</span>, <span class="ruby-identifier">mode</span>=<span class="ruby-identifier">:exclusive</span>)&#x000A;            <span class="ruby-identifier">raise</span> <span class="ruby-constant">MapperError</span>, <span class="ruby-value str">&quot;Unimplemented&quot;</span>&#x000A;        <span class="ruby-keyword kw">end</span></pre>
                </div>
              </div>
              <div class='public-instance method' id='method-M000445'>
                <a name='M000445'>      </a>
                <div class='synopsis'>
                  <span class='name'>map</span>
                  <span class='arguments'>(request, result, obj)</span>
                </div>
                <div class='description'>
                  <p>
                  Transforms a <a href="Storage.html">Storage</a> result into an object.
                  Should be implemented by subclasses.
                  </p>
                </div>
                <div class='source'>
                  <a class='source-toggle' href='#' onclick="toggleCode('M000445-source'); return false">
                    [show source]
                  </a>
                  <pre id='M000445-source'><span class="ruby-comment cmt"># File lib/spiderfw/model/mappers/mapper.rb, line 442</span>&#x000A;        <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">map</span>(<span class="ruby-identifier">request</span>, <span class="ruby-identifier">result</span>, <span class="ruby-identifier">obj</span>)&#x000A;            <span class="ruby-identifier">raise</span> <span class="ruby-constant">MapperError</span>, <span class="ruby-value str">&quot;Unimplemented&quot;</span>&#x000A;        <span class="ruby-keyword kw">end</span></pre>
                </div>
              </div>
              <div class='public-instance method' id='method-M000449'>
                <a name='M000449'>      </a>
                <div class='synopsis'>
                  <span class='name'>map_back_value</span>
                  <span class='arguments'>(type, value)</span>
                </div>
                <div class='description'>
                  <p>
                  Converts a value from the storage to a value for the object.
                  </p>
                </div>
                <div class='source'>
                  <a class='source-toggle' href='#' onclick="toggleCode('M000449-source'); return false">
                    [show source]
                  </a>
                  <pre id='M000449-source'><span class="ruby-comment cmt"># File lib/spiderfw/model/mappers/mapper.rb, line 545</span>&#x000A;        <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">map_back_value</span>(<span class="ruby-identifier">type</span>, <span class="ruby-identifier">value</span>)&#x000A;            <span class="ruby-identifier">raise</span> <span class="ruby-constant">MapperError</span>, <span class="ruby-value str">&quot;Unimplemented&quot;</span>&#x000A;        <span class="ruby-keyword kw">end</span></pre>
                </div>
              </div>
              <div class='public-instance method' id='method-M000416'>
                <a name='M000416'>      </a>
                <div class='synopsis'>
                  <span class='name'>mapped?</span>
                  <span class='arguments'>(element)</span>
                </div>
                <div class='description'>
                  <p>
                  Returns whether the given element can be handled by the mapper.
                  </p>
                </div>
                <div class='source'>
                  <a class='source-toggle' href='#' onclick="toggleCode('M000416-source'); return false">
                    [show source]
                  </a>
                  <pre id='M000416-source'><span class="ruby-comment cmt"># File lib/spiderfw/model/mappers/mapper.rb, line 36</span>&#x000A;        <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">mapped?</span>(<span class="ruby-identifier">element</span>)&#x000A;            <span class="ruby-identifier">element</span> = <span class="ruby-identifier">element</span>.<span class="ruby-identifier">name</span> <span class="ruby-keyword kw">if</span> (<span class="ruby-identifier">element</span>.<span class="ruby-identifier">is_a?</span> <span class="ruby-constant">Element</span>)&#x000A;            <span class="ruby-identifier">element</span> = <span class="ruby-ivar">@model</span>.<span class="ruby-identifier">elements</span>[<span class="ruby-identifier">element</span>]&#x000A;            <span class="ruby-keyword kw">return</span> <span class="ruby-keyword kw">false</span> <span class="ruby-keyword kw">if</span> (<span class="ruby-identifier">element</span>.<span class="ruby-identifier">attributes</span>[<span class="ruby-identifier">:unmapped</span>])&#x000A;            <span class="ruby-keyword kw">return</span> <span class="ruby-keyword kw">false</span> <span class="ruby-keyword kw">if</span> (<span class="ruby-identifier">element</span>.<span class="ruby-identifier">attributes</span>[<span class="ruby-identifier">:computed_from</span>])&#x000A;            <span class="ruby-keyword kw">return</span> <span class="ruby-keyword kw">false</span> <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@no_map_elements</span>[<span class="ruby-identifier">element</span>.<span class="ruby-identifier">name</span>]&#x000A;            <span class="ruby-keyword kw">return</span> <span class="ruby-keyword kw">true</span>&#x000A;        <span class="ruby-keyword kw">end</span></pre>
                </div>
              </div>
              <div class='public-instance method' id='method-M000415'>
                <a name='M000415'>      </a>
                <div class='synopsis'>
                  <span class='name'>no_map</span>
                  <span class='arguments'>(*els)</span>
                </div>
                <div class='description'>
                  <p>
                  Sets that the given elements will not be processed.
                  </p>
                </div>
                <div class='source'>
                  <a class='source-toggle' href='#' onclick="toggleCode('M000415-source'); return false">
                    [show source]
                  </a>
                  <pre id='M000415-source'><span class="ruby-comment cmt"># File lib/spiderfw/model/mappers/mapper.rb, line 31</span>&#x000A;        <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">no_map</span>(<span class="ruby-operator">*</span><span class="ruby-identifier">els</span>)&#x000A;            <span class="ruby-identifier">els</span>.<span class="ruby-identifier">each</span>{ <span class="ruby-operator">|</span><span class="ruby-identifier">el</span><span class="ruby-operator">|</span> <span class="ruby-ivar">@no_map_elements</span>[<span class="ruby-identifier">el</span>] = <span class="ruby-keyword kw">true</span> }&#x000A;        <span class="ruby-keyword kw">end</span></pre>
                </div>
              </div>
              <div class='public-instance method' id='method-M000417'>
                <a name='M000417'>      </a>
                <div class='synopsis'>
                  <span class='name'>normalize</span>
                  <span class='arguments'>(obj)</span>
                </div>
                <div class='description'>
                  <p>
                  Converts hashes and arrays to QuerySets and <a
                  href="BaseModel.html">BaseModel</a> instances.
                  </p>
                </div>
                <div class='source'>
                  <a class='source-toggle' href='#' onclick="toggleCode('M000417-source'); return false">
                    [show source]
                  </a>
                  <pre id='M000417-source'><span class="ruby-comment cmt"># File lib/spiderfw/model/mappers/mapper.rb, line 65</span>&#x000A;        <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">normalize</span>(<span class="ruby-identifier">obj</span>)&#x000A;            <span class="ruby-identifier">obj</span>.<span class="ruby-identifier">no_autoload</span> <span class="ruby-keyword kw">do</span>&#x000A;                <span class="ruby-ivar">@model</span>.<span class="ruby-identifier">elements</span>.<span class="ruby-identifier">select</span>{ <span class="ruby-operator">|</span><span class="ruby-identifier">n</span>, <span class="ruby-identifier">el</span><span class="ruby-operator">|</span> &#x000A;                        <span class="ruby-identifier">mapped?</span>(<span class="ruby-identifier">el</span>) <span class="ruby-operator">&amp;&amp;</span>  <span class="ruby-identifier">el</span>.<span class="ruby-identifier">model?</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">obj</span>.<span class="ruby-identifier">element_has_value?</span>(<span class="ruby-identifier">el</span>) &#x000A;                }.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">name</span>, <span class="ruby-identifier">element</span><span class="ruby-operator">|</span>&#x000A;                    <span class="ruby-identifier">val</span> = <span class="ruby-identifier">obj</span>.<span class="ruby-identifier">get</span>(<span class="ruby-identifier">name</span>)&#x000A;                    <span class="ruby-keyword kw">next</span> <span class="ruby-keyword kw">if</span> (<span class="ruby-identifier">val</span>.<span class="ruby-identifier">is_a?</span>(<span class="ruby-constant">BaseModel</span>) <span class="ruby-operator">||</span> <span class="ruby-identifier">val</span>.<span class="ruby-identifier">is_a?</span>(<span class="ruby-constant">QuerySet</span>))&#x000A;                    <span class="ruby-keyword kw">if</span> (<span class="ruby-identifier">val</span>.<span class="ruby-identifier">is_a?</span> <span class="ruby-constant">Array</span>)&#x000A;                        <span class="ruby-identifier">val</span>.<span class="ruby-identifier">each_index</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">i</span><span class="ruby-operator">|</span> <span class="ruby-identifier">val</span>[<span class="ruby-identifier">i</span>] = <span class="ruby-constant">Spider</span><span class="ruby-operator">::</span><span class="ruby-constant">Model</span>.<span class="ruby-identifier">get</span>(<span class="ruby-identifier">element</span>.<span class="ruby-identifier">model</span>, <span class="ruby-identifier">val</span>[<span class="ruby-identifier">i</span>]) <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">val</span>[<span class="ruby-identifier">i</span>].<span class="ruby-identifier">is_a?</span>(<span class="ruby-constant">BaseModel</span>) <span class="ruby-operator">||</span> <span class="ruby-identifier">val</span>.<span class="ruby-identifier">is_a?</span>(<span class="ruby-constant">QuerySet</span>) }&#x000A;                        <span class="ruby-identifier">obj</span>.<span class="ruby-identifier">set</span>(<span class="ruby-identifier">name</span>, <span class="ruby-constant">QuerySet</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">element</span>.<span class="ruby-identifier">model</span>, <span class="ruby-identifier">val</span>))&#x000A;                    <span class="ruby-keyword kw">else</span>&#x000A;                        <span class="ruby-identifier">val</span> = <span class="ruby-constant">Spider</span><span class="ruby-operator">::</span><span class="ruby-constant">Model</span>.<span class="ruby-identifier">get</span>(<span class="ruby-identifier">element</span>.<span class="ruby-identifier">model</span>, <span class="ruby-identifier">val</span>)&#x000A;                        <span class="ruby-identifier">obj</span>.<span class="ruby-identifier">set</span>(<span class="ruby-identifier">name</span>, <span class="ruby-identifier">val</span>)&#x000A;                    <span class="ruby-keyword kw">end</span>&#x000A;                <span class="ruby-keyword kw">end</span>&#x000A;            <span class="ruby-keyword kw">end</span>&#x000A;        <span class="ruby-keyword kw">end</span></pre>
                </div>
              </div>
              <div class='public-instance method' id='method-M000432'>
                <a name='M000432'>      </a>
                <div class='synopsis'>
                  <span class='name'>prepare_delete_condition</span>
                  <span class='arguments'>(obj)</span>
                </div>
                <div class='source'>
                  <a class='source-toggle' href='#' onclick="toggleCode('M000432-source'); return false">
                    [show source]
                  </a>
                  <pre id='M000432-source'><span class="ruby-comment cmt"># File lib/spiderfw/model/mappers/mapper.rb, line 269</span>&#x000A;            <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">prepare_delete_condition</span>(<span class="ruby-identifier">obj</span>)&#x000A;                <span class="ruby-identifier">condition</span> = <span class="ruby-constant">Condition</span>.<span class="ruby-identifier">and</span>&#x000A;                <span class="ruby-ivar">@model</span>.<span class="ruby-identifier">primary_keys</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">key</span><span class="ruby-operator">|</span>&#x000A;                    <span class="ruby-identifier">condition</span>[<span class="ruby-identifier">key</span>.<span class="ruby-identifier">name</span>] = <span class="ruby-identifier">map_condition_value</span>(<span class="ruby-identifier">key</span>.<span class="ruby-identifier">type</span>, <span class="ruby-identifier">obj</span>.<span class="ruby-identifier">get</span>(<span class="ruby-identifier">key</span>))&#x000A;                <span class="ruby-keyword kw">end</span>&#x000A;                <span class="ruby-keyword kw">return</span> <span class="ruby-identifier">condition</span>&#x000A;            <span class="ruby-keyword kw">end</span></pre>
                </div>
              </div>
              <div class='public-instance method' id='method-M000450'>
                <a name='M000450'>      </a>
                <div class='synopsis'>
                  <span class='name'>prepare_query</span>
                  <span class='arguments'>(query, obj=nil)</span>
                </div>
                <div class='description'>
                  <p>
                  Strategy #
                  </p>
                </div>
                <div class='source'>
                  <a class='source-toggle' href='#' onclick="toggleCode('M000450-source'); return false">
                    [show source]
                  </a>
                  <pre id='M000450-source'><span class="ruby-comment cmt"># File lib/spiderfw/model/mappers/mapper.rb, line 554</span>&#x000A;        <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">prepare_query</span>(<span class="ruby-identifier">query</span>, <span class="ruby-identifier">obj</span>=<span class="ruby-keyword kw">nil</span>)&#x000A;            <span class="ruby-identifier">prepare_query_request</span>(<span class="ruby-identifier">query</span>.<span class="ruby-identifier">request</span>, <span class="ruby-identifier">obj</span>)&#x000A;            <span class="ruby-identifier">prepare_query_condition</span>(<span class="ruby-identifier">query</span>.<span class="ruby-identifier">condition</span>)&#x000A;            <span class="ruby-keyword kw">return</span> <span class="ruby-identifier">query</span>&#x000A;        <span class="ruby-keyword kw">end</span></pre>
                </div>
              </div>
              <div class='public-instance method' id='method-M000453'>
                <a name='M000453'>      </a>
                <div class='synopsis'>
                  <span class='name'>prepare_query_condition</span>
                  <span class='arguments'>(condition)</span>
                </div>
                <div class='description'>
                  <p>
                  Preprocessing of the condition
                  </p>
                </div>
                <div class='source'>
                  <a class='source-toggle' href='#' onclick="toggleCode('M000453-source'); return false">
                    [show source]
                  </a>
                  <pre id='M000453-source'><span class="ruby-comment cmt"># File lib/spiderfw/model/mappers/mapper.rb, line 599</span>&#x000A;        <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">prepare_query_condition</span>(<span class="ruby-identifier">condition</span>)&#x000A;            <span class="ruby-identifier">model</span> = <span class="ruby-identifier">condition</span>.<span class="ruby-identifier">polymorph</span> <span class="ruby-value">? </span><span class="ruby-identifier">condition</span>.<span class="ruby-identifier">polymorph</span> <span class="ruby-operator">:</span> <span class="ruby-ivar">@model</span>&#x000A;            <span class="ruby-identifier">condition</span>.<span class="ruby-identifier">each_with_comparison</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">k</span>, <span class="ruby-identifier">v</span>, <span class="ruby-identifier">c</span><span class="ruby-operator">|</span>&#x000A;                <span class="ruby-identifier">raise</span> <span class="ruby-constant">MapperError</span>, <span class="ruby-node">&quot;Condition for nonexistent element #{k}&quot;</span> <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">element</span> = <span class="ruby-identifier">model</span>.<span class="ruby-identifier">elements</span>[<span class="ruby-identifier">k</span>]&#x000A;                <span class="ruby-keyword kw">if</span> (<span class="ruby-identifier">element</span>.<span class="ruby-identifier">integrated?</span>)&#x000A;                    <span class="ruby-identifier">condition</span>.<span class="ruby-identifier">delete</span>(<span class="ruby-identifier">k</span>)&#x000A;                    <span class="ruby-identifier">integrated_from</span> = <span class="ruby-identifier">element</span>.<span class="ruby-identifier">integrated_from</span>&#x000A;                    <span class="ruby-identifier">integrated_from_element</span> = <span class="ruby-identifier">element</span>.<span class="ruby-identifier">integrated_from_element</span>&#x000A;                    <span class="ruby-identifier">condition</span>.<span class="ruby-identifier">set</span>(<span class="ruby-node">&quot;#{integrated_from.name}.#{integrated_from_element}&quot;</span>, <span class="ruby-identifier">c</span>, <span class="ruby-identifier">v</span>)&#x000A;                <span class="ruby-keyword kw">elsif</span> (<span class="ruby-identifier">element</span>.<span class="ruby-identifier">junction?</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-operator">!</span><span class="ruby-identifier">v</span>.<span class="ruby-identifier">is_a?</span>(<span class="ruby-constant">BaseModel</span>) <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-operator">!</span><span class="ruby-identifier">v</span>.<span class="ruby-identifier">is_a?</span>(<span class="ruby-constant">Hash</span>)) <span class="ruby-comment cmt"># conditions on junction id don't make sense</span>&#x000A;                    <span class="ruby-identifier">condition</span>.<span class="ruby-identifier">delete</span>(<span class="ruby-identifier">k</span>)&#x000A;                    <span class="ruby-identifier">condition</span>.<span class="ruby-identifier">set</span>(<span class="ruby-node">&quot;#{k}.#{element.attributes[:junction_their_element]}&quot;</span>, <span class="ruby-identifier">c</span>, <span class="ruby-identifier">v</span>)&#x000A;                <span class="ruby-keyword kw">end</span>&#x000A;                <span class="ruby-keyword kw">if</span> (<span class="ruby-identifier">element</span>.<span class="ruby-identifier">type</span> <span class="ruby-operator">&lt;</span> <span class="ruby-constant">Spider</span><span class="ruby-operator">::</span><span class="ruby-constant">DataType</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-operator">!</span><span class="ruby-identifier">v</span>.<span class="ruby-identifier">is_a?</span>(<span class="ruby-identifier">element</span>.<span class="ruby-identifier">type</span>))&#x000A;                    <span class="ruby-identifier">condition</span>.<span class="ruby-identifier">delete</span>(<span class="ruby-identifier">k</span>)&#x000A;                    <span class="ruby-identifier">condition</span>[<span class="ruby-identifier">k</span>] = <span class="ruby-identifier">element</span>.<span class="ruby-identifier">type</span>.<span class="ruby-identifier">from_value</span>(<span class="ruby-identifier">v</span>)&#x000A;                <span class="ruby-keyword kw">elsif</span> <span class="ruby-identifier">element</span>.<span class="ruby-identifier">type</span> <span class="ruby-operator">==</span> <span class="ruby-constant">DateTime</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">v</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-operator">!</span><span class="ruby-identifier">v</span>.<span class="ruby-identifier">is_a?</span>(<span class="ruby-constant">Date</span>)&#x000A;                    <span class="ruby-identifier">condition</span>.<span class="ruby-identifier">delete</span>(<span class="ruby-identifier">k</span>)&#x000A;                    <span class="ruby-identifier">condition</span>[<span class="ruby-identifier">k</span>] = <span class="ruby-constant">DateTime</span>.<span class="ruby-identifier">parse</span>(<span class="ruby-identifier">v</span>)&#x000A;                <span class="ruby-keyword kw">end</span>&#x000A;                    &#x000A;            <span class="ruby-keyword kw">end</span>&#x000A;            <span class="ruby-identifier">condition</span>.<span class="ruby-identifier">subconditions</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">sub</span><span class="ruby-operator">|</span>&#x000A;                <span class="ruby-identifier">prepare_query_condition</span>(<span class="ruby-identifier">sub</span>)&#x000A;            <span class="ruby-keyword kw">end</span>&#x000A;            <span class="ruby-identifier">condition</span>.<span class="ruby-identifier">simplify</span>&#x000A;        <span class="ruby-keyword kw">end</span></pre>
                </div>
              </div>
              <div class='public-instance method' id='method-M000451'>
                <a name='M000451'>      </a>
                <div class='synopsis'>
                  <span class='name'>prepare_query_request</span>
                  <span class='arguments'>(request, obj=nil)</span>
                </div>
                <div class='description'>
                  <p>
                  Normalizes a request.
                  </p>
                </div>
                <div class='source'>
                  <a class='source-toggle' href='#' onclick="toggleCode('M000451-source'); return false">
                    [show source]
                  </a>
                  <pre id='M000451-source'><span class="ruby-comment cmt"># File lib/spiderfw/model/mappers/mapper.rb, line 562</span>&#x000A;        <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">prepare_query_request</span>(<span class="ruby-identifier">request</span>, <span class="ruby-identifier">obj</span>=<span class="ruby-keyword kw">nil</span>)&#x000A;            <span class="ruby-ivar">@model</span>.<span class="ruby-identifier">primary_keys</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">key</span><span class="ruby-operator">|</span>&#x000A;                <span class="ruby-identifier">request</span>[<span class="ruby-identifier">key</span>] = <span class="ruby-keyword kw">true</span>&#x000A;            <span class="ruby-keyword kw">end</span>&#x000A;            <span class="ruby-identifier">request</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">k</span>, <span class="ruby-identifier">v</span><span class="ruby-operator">|</span>&#x000A;                <span class="ruby-keyword kw">next</span> <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">element</span> = <span class="ruby-ivar">@model</span>.<span class="ruby-identifier">elements</span>[<span class="ruby-identifier">k</span>]&#x000A;                <span class="ruby-keyword kw">if</span> (<span class="ruby-identifier">element</span>.<span class="ruby-identifier">integrated?</span>)&#x000A;                    <span class="ruby-identifier">integrated_from</span> = <span class="ruby-identifier">element</span>.<span class="ruby-identifier">integrated_from</span>&#x000A;                    <span class="ruby-identifier">integrated_from_element</span> = <span class="ruby-identifier">element</span>.<span class="ruby-identifier">integrated_from_element</span>&#x000A;                    <span class="ruby-identifier">request</span>.<span class="ruby-identifier">request</span>(<span class="ruby-node">&quot;#{integrated_from.name}.#{integrated_from_element}&quot;</span>)&#x000A;                <span class="ruby-keyword kw">end</span>&#x000A;            <span class="ruby-keyword kw">end</span>&#x000A;        <span class="ruby-keyword kw">end</span></pre>
                </div>
              </div>
              <div class='public-instance method' id='method-M000448'>
                <a name='M000448'>      </a>
                <div class='synopsis'>
                  <span class='name'>queryset_siblings</span>
                  <span class='arguments'>(obj)</span>
                </div>
                <div class='description'>
                  <p>
                  Returns the siblings, if any, of the object, in its ancestor <a
                  href="QuerySet.html">QuerySet</a>.
                  </p>
                </div>
                <div class='source'>
                  <a class='source-toggle' href='#' onclick="toggleCode('M000448-source'); return false">
                    [show source]
                  </a>
                  <pre id='M000448-source'><span class="ruby-comment cmt"># File lib/spiderfw/model/mappers/mapper.rb, line 527</span>&#x000A;        <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">queryset_siblings</span>(<span class="ruby-identifier">obj</span>)&#x000A;            <span class="ruby-keyword kw">return</span> <span class="ruby-constant">QuerySet</span>.<span class="ruby-identifier">new</span>(<span class="ruby-ivar">@model</span>, <span class="ruby-identifier">obj</span>) <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">obj</span>.<span class="ruby-identifier">_parent</span>&#x000A;            <span class="ruby-identifier">orig_obj</span> = <span class="ruby-identifier">obj</span>&#x000A;            <span class="ruby-identifier">path</span> = []&#x000A;            <span class="ruby-identifier">seen</span> = {<span class="ruby-identifier">obj</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-keyword kw">true</span>}&#x000A;            <span class="ruby-keyword kw">while</span> (<span class="ruby-identifier">obj</span>.<span class="ruby-identifier">_parent</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-operator">!</span><span class="ruby-identifier">seen</span>[<span class="ruby-identifier">obj</span>.<span class="ruby-identifier">_parent</span>])&#x000A;                <span class="ruby-identifier">path</span>.<span class="ruby-identifier">unshift</span>(<span class="ruby-identifier">obj</span>.<span class="ruby-identifier">_parent_element</span>) <span class="ruby-keyword kw">if</span> (<span class="ruby-identifier">obj</span>.<span class="ruby-identifier">_parent_element</span>) <span class="ruby-comment cmt"># otherwise it's a query set</span>&#x000A;                <span class="ruby-identifier">obj</span> = <span class="ruby-identifier">obj</span>.<span class="ruby-identifier">_parent</span>&#x000A;                <span class="ruby-identifier">seen</span>[<span class="ruby-identifier">obj</span>] = <span class="ruby-keyword kw">true</span>&#x000A;            <span class="ruby-keyword kw">end</span>&#x000A;            <span class="ruby-identifier">res</span> = <span class="ruby-identifier">path</span>.<span class="ruby-identifier">empty?</span> <span class="ruby-value">? </span><span class="ruby-identifier">obj</span> <span class="ruby-operator">:</span> <span class="ruby-identifier">obj</span>.<span class="ruby-identifier">all_children</span>(<span class="ruby-identifier">path</span>)&#x000A;            <span class="ruby-identifier">raise</span> <span class="ruby-constant">RuntimeError</span>, <span class="ruby-value str">&quot;Broken object path&quot;</span> <span class="ruby-keyword kw">if</span> (<span class="ruby-identifier">obj</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-operator">!</span><span class="ruby-identifier">path</span>.<span class="ruby-identifier">empty?</span> <span class="ruby-operator">&amp;&amp;</span>  <span class="ruby-identifier">res</span>.<span class="ruby-identifier">length</span> <span class="ruby-operator">&lt;</span> <span class="ruby-value">1</span>)&#x000A;            <span class="ruby-identifier">res</span> = <span class="ruby-constant">QuerySet</span>.<span class="ruby-identifier">new</span>(<span class="ruby-ivar">@model</span>, <span class="ruby-identifier">res</span>) <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">res</span>.<span class="ruby-identifier">is_a?</span>(<span class="ruby-constant">QuerySet</span>)&#x000A;            <span class="ruby-keyword kw">return</span> <span class="ruby-identifier">res</span>&#x000A;        <span class="ruby-keyword kw">end</span></pre>
                </div>
              </div>
              <div class='public-instance method' id='method-M000423'>
                <a name='M000423'>      </a>
                <div class='synopsis'>
                  <span class='name'>save</span>
                  <span class='arguments'>(obj, request=nil)</span>
                </div>
                <div class='description'>
                  <p>
                  Saves the object to the storage.
                  </p>
                </div>
                <div class='source'>
                  <a class='source-toggle' href='#' onclick="toggleCode('M000423-source'); return false">
                    [show source]
                  </a>
                  <pre id='M000423-source'><span class="ruby-comment cmt"># File lib/spiderfw/model/mappers/mapper.rb, line 156</span>&#x000A;        <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">save</span>(<span class="ruby-identifier">obj</span>, <span class="ruby-identifier">request</span>=<span class="ruby-keyword kw">nil</span>)&#x000A;            <span class="ruby-keyword kw">if</span> (<span class="ruby-ivar">@model</span>.<span class="ruby-identifier">extended_models</span>)&#x000A;                <span class="ruby-identifier">is_insert</span> = <span class="ruby-keyword kw">false</span>&#x000A;                <span class="ruby-comment cmt"># Load local primary keys if they exist</span>&#x000A;                <span class="ruby-comment cmt"># FIXME: load without cloning?</span>&#x000A;                <span class="ruby-identifier">check_obj</span> = <span class="ruby-identifier">obj</span>.<span class="ruby-identifier">clone</span>&#x000A;                <span class="ruby-ivar">@model</span>.<span class="ruby-identifier">elements_array</span>.<span class="ruby-identifier">select</span>{ <span class="ruby-operator">|</span><span class="ruby-identifier">el</span><span class="ruby-operator">|</span> <span class="ruby-identifier">el</span>.<span class="ruby-identifier">attributes</span>[<span class="ruby-identifier">:local_pk</span>] }.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">local_pk</span><span class="ruby-operator">|</span>&#x000A;                    <span class="ruby-identifier">check_obj</span>.<span class="ruby-identifier">get</span>(<span class="ruby-identifier">local_pk</span>)&#x000A;                <span class="ruby-keyword kw">end</span>&#x000A;                <span class="ruby-ivar">@model</span>.<span class="ruby-identifier">elements_array</span>.<span class="ruby-identifier">select</span>{ <span class="ruby-operator">|</span><span class="ruby-identifier">el</span><span class="ruby-operator">|</span> <span class="ruby-identifier">el</span>.<span class="ruby-identifier">attributes</span>[<span class="ruby-identifier">:local_pk</span>]}.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">local_pk</span><span class="ruby-operator">|</span>&#x000A;                    <span class="ruby-keyword kw">if</span> (<span class="ruby-operator">!</span><span class="ruby-identifier">check_obj</span>.<span class="ruby-identifier">element_has_value?</span>(<span class="ruby-identifier">local_pk</span>))&#x000A;                        <span class="ruby-identifier">is_insert</span> = <span class="ruby-keyword kw">true</span>&#x000A;                        <span class="ruby-keyword kw">break</span>&#x000A;                    <span class="ruby-keyword kw">end</span>&#x000A;                <span class="ruby-keyword kw">end</span>&#x000A;            <span class="ruby-keyword kw">end</span>&#x000A;            <span class="ruby-identifier">save_mode</span> = (<span class="ruby-operator">!</span><span class="ruby-identifier">is_insert</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">obj</span>.<span class="ruby-identifier">primary_keys_set?</span>) <span class="ruby-operator">?</span> <span class="ruby-identifier">:update</span> <span class="ruby-operator">:</span> <span class="ruby-identifier">:insert</span>&#x000A;            <span class="ruby-identifier">before_save</span>(<span class="ruby-identifier">obj</span>, <span class="ruby-identifier">save_mode</span>)&#x000A;            <span class="ruby-comment cmt"># @model.elements_array.select{ |el| el.attributes[:integrated_model] }.each do |el|</span>&#x000A;            <span class="ruby-comment cmt">#     obj.get(el).save if obj.element_modified?(el)</span>&#x000A;            <span class="ruby-comment cmt"># end</span>&#x000A;            <span class="ruby-keyword kw">if</span> (<span class="ruby-identifier">save_mode</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">:update</span>)&#x000A;                <span class="ruby-identifier">do_update</span>(<span class="ruby-identifier">obj</span>)&#x000A;            <span class="ruby-keyword kw">else</span>&#x000A;                <span class="ruby-identifier">do_insert</span>(<span class="ruby-identifier">obj</span>)&#x000A;            <span class="ruby-keyword kw">end</span>&#x000A;            <span class="ruby-identifier">after_save</span>(<span class="ruby-identifier">obj</span>, <span class="ruby-identifier">save_mode</span>)&#x000A;        <span class="ruby-keyword kw">end</span></pre>
                </div>
              </div>
              <div class='public-instance method' id='method-M000428'>
                <a name='M000428'>      </a>
                <div class='synopsis'>
                  <span class='name'>save_all</span>
                  <span class='arguments'>(root)</span>
                </div>
                <div class='description'>
                  <p>
                  Saves the given object and all objects reachable from it.
                  </p>
                </div>
                <div class='source'>
                  <a class='source-toggle' href='#' onclick="toggleCode('M000428-source'); return false">
                    [show source]
                  </a>
                  <pre id='M000428-source'><span class="ruby-comment cmt"># File lib/spiderfw/model/mappers/mapper.rb, line 241</span>&#x000A;        <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">save_all</span>(<span class="ruby-identifier">root</span>)&#x000A;            <span class="ruby-identifier">uow</span> = <span class="ruby-constant">UnitOfWork</span>.<span class="ruby-identifier">new</span>&#x000A;            <span class="ruby-identifier">uow</span>.<span class="ruby-identifier">add</span>(<span class="ruby-identifier">root</span>)&#x000A;            <span class="ruby-identifier">uow</span>.<span class="ruby-identifier">run</span>()&#x000A;        <span class="ruby-keyword kw">end</span></pre>
                </div>
              </div>
              <div class='public-instance method' id='method-M000425'>
                <a name='M000425'>      </a>
                <div class='synopsis'>
                  <span class='name'>save_associations</span>
                  <span class='arguments'>(obj)</span>
                </div>
                <div class='description'>
                  <p>
                  Saves object associations.
                  </p>
                </div>
                <div class='source'>
                  <a class='source-toggle' href='#' onclick="toggleCode('M000425-source'); return false">
                    [show source]
                  </a>
                  <pre id='M000425-source'><span class="ruby-comment cmt"># File lib/spiderfw/model/mappers/mapper.rb, line 191</span>&#x000A;        <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">save_associations</span>(<span class="ruby-identifier">obj</span>)&#x000A;            <span class="ruby-identifier">association_elements</span>.<span class="ruby-identifier">select</span>{ <span class="ruby-operator">|</span><span class="ruby-identifier">el</span><span class="ruby-operator">|</span> <span class="ruby-identifier">obj</span>.<span class="ruby-identifier">element_has_value?</span>(<span class="ruby-identifier">el</span>) }.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">el</span><span class="ruby-operator">|</span>&#x000A;                <span class="ruby-identifier">save_element_associations</span>(<span class="ruby-identifier">obj</span>, <span class="ruby-identifier">el</span>)&#x000A;            <span class="ruby-keyword kw">end</span>&#x000A;        <span class="ruby-keyword kw">end</span></pre>
                </div>
              </div>
              <div class='public-instance method' id='method-M000427'>
                <a name='M000427'>      </a>
                <div class='synopsis'>
                  <span class='name'>save_element_associations</span>
                  <span class='arguments'>(obj, element)</span>
                </div>
                <div class='description'>
                  <p>
                  Saves the associations from the given object to the element.
                  </p>
                </div>
                <div class='source'>
                  <a class='source-toggle' href='#' onclick="toggleCode('M000427-source'); return false">
                    [show source]
                  </a>
                  <pre id='M000427-source'><span class="ruby-comment cmt"># File lib/spiderfw/model/mappers/mapper.rb, line 216</span>&#x000A;        <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">save_element_associations</span>(<span class="ruby-identifier">obj</span>, <span class="ruby-identifier">element</span>)&#x000A;            <span class="ruby-identifier">delete_element_associations</span>(<span class="ruby-identifier">obj</span>, <span class="ruby-identifier">element</span>)&#x000A;            <span class="ruby-keyword kw">if</span> (<span class="ruby-identifier">element</span>.<span class="ruby-identifier">attributes</span>[<span class="ruby-identifier">:junction</span>])&#x000A;                <span class="ruby-identifier">val</span> = <span class="ruby-identifier">obj</span>.<span class="ruby-identifier">get</span>(<span class="ruby-identifier">element</span>)&#x000A;                <span class="ruby-keyword kw">if</span> (<span class="ruby-identifier">val</span>.<span class="ruby-identifier">is_a?</span>(<span class="ruby-constant">QuerySet</span>) <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">val</span>.<span class="ruby-identifier">model</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">element</span>.<span class="ruby-identifier">type</span>) <span class="ruby-comment cmt"># construct the junction</span>&#x000A;                    <span class="ruby-identifier">qs</span> = <span class="ruby-constant">QuerySet</span>.<span class="ruby-identifier">static</span>(<span class="ruby-identifier">element</span>.<span class="ruby-identifier">model</span>, <span class="ruby-identifier">val</span>.<span class="ruby-identifier">map</span>{ <span class="ruby-operator">|</span><span class="ruby-identifier">el_obj</span><span class="ruby-operator">|</span>&#x000A;                        {<span class="ruby-identifier">element</span>.<span class="ruby-identifier">attributes</span>[<span class="ruby-identifier">:reverse</span>] =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">obj</span>, <span class="ruby-identifier">element</span>.<span class="ruby-identifier">attributes</span>[<span class="ruby-identifier">:junction_their_element</span>] =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">el_obj</span>}&#x000A;                    })&#x000A;                    <span class="ruby-identifier">val</span> = <span class="ruby-identifier">qs</span>&#x000A;                <span class="ruby-keyword kw">elsif</span> (<span class="ruby-identifier">val</span>.<span class="ruby-identifier">is_a?</span>(<span class="ruby-constant">QuerySet</span>))&#x000A;                    <span class="ruby-identifier">val</span>.<span class="ruby-identifier">no_autoload</span> <span class="ruby-keyword kw">do</span>&#x000A;                        <span class="ruby-identifier">val</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">row</span><span class="ruby-operator">|</span>&#x000A;                            <span class="ruby-identifier">row</span>.<span class="ruby-identifier">set</span>(<span class="ruby-identifier">element</span>.<span class="ruby-identifier">attributes</span>[<span class="ruby-identifier">:reverse</span>], <span class="ruby-identifier">obj</span>)&#x000A;                        <span class="ruby-keyword kw">end</span>&#x000A;                    <span class="ruby-keyword kw">end</span>&#x000A;                <span class="ruby-keyword kw">end</span>&#x000A;                <span class="ruby-identifier">val</span>.<span class="ruby-identifier">insert</span>&#x000A;            <span class="ruby-keyword kw">else</span>&#x000A;                <span class="ruby-identifier">associated</span> = <span class="ruby-identifier">obj</span>.<span class="ruby-identifier">get</span>(<span class="ruby-identifier">element</span>)&#x000A;                <span class="ruby-identifier">associated</span>.<span class="ruby-identifier">set</span>(<span class="ruby-identifier">element</span>.<span class="ruby-identifier">reverse</span>, <span class="ruby-identifier">obj</span>)&#x000A;                <span class="ruby-identifier">associated</span>.<span class="ruby-identifier">save</span>&#x000A;            <span class="ruby-keyword kw">end</span>&#x000A;        <span class="ruby-keyword kw">end</span></pre>
                </div>
              </div>
              <div class='public-instance method' id='method-M000438'>
                <a name='M000438'>      </a>
                <div class='synopsis'>
                  <span class='name'>sequence_next</span>
                  <span class='arguments'>(name)</span>
                </div>
                <div class='description'>
                  <p>
                  Actual interaction with the storage. May be implemented by subclasses.
                  </p>
                </div>
                <div class='source'>
                  <a class='source-toggle' href='#' onclick="toggleCode('M000438-source'); return false">
                    [show source]
                  </a>
                  <pre id='M000438-source'><span class="ruby-comment cmt"># File lib/spiderfw/model/mappers/mapper.rb, line 337</span>&#x000A;        <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">sequence_next</span>(<span class="ruby-identifier">name</span>)&#x000A;            <span class="ruby-identifier">raise</span> <span class="ruby-constant">MapperError</span>, <span class="ruby-value str">&quot;Unimplemented&quot;</span>&#x000A;        <span class="ruby-keyword kw">end</span></pre>
                </div>
              </div>
              <div class='public-instance method' id='method-M000430'>
                <a name='M000430'>      </a>
                <div class='synopsis'>
                  <span class='name'>update</span>
                  <span class='arguments'>(obj)</span>
                </div>
                <div class='description'>
                  <p>
                  Updates the object in the storage.
                  </p>
                </div>
                <div class='source'>
                  <a class='source-toggle' href='#' onclick="toggleCode('M000430-source'); return false">
                    [show source]
                  </a>
                  <pre id='M000430-source'><span class="ruby-comment cmt"># File lib/spiderfw/model/mappers/mapper.rb, line 255</span>&#x000A;        <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">update</span>(<span class="ruby-identifier">obj</span>)&#x000A;            <span class="ruby-identifier">before_save</span>(<span class="ruby-identifier">obj</span>, <span class="ruby-identifier">:update</span>)&#x000A;            <span class="ruby-identifier">do_update</span>(<span class="ruby-identifier">obj</span>)&#x000A;            <span class="ruby-identifier">after_save</span>(<span class="ruby-identifier">obj</span>, <span class="ruby-identifier">:update</span>)&#x000A;        <span class="ruby-keyword kw">end</span></pre>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div id='footer-push'></div>
    </div>
    <div id='footer'>
      <a href="http://github.com/mislav/hanna/tree/master"><strong>Hanna</strong> RDoc template</a>
    </div>
  </body>
</html>
